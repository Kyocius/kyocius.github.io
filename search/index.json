[{"content":"å‰è¨€ æ­¤ç³»åˆ—æ–‡ç« æ˜¯ã€ŠDigital Design and Computer Architecture: RISC-V Editionã€‹çš„è¯»ä¹¦ç¬”è®°ã€‚\næ•°å­—æŠ½è±¡çš„æ·±å±‚å«ä¹‰ æ•°å­—ç”µè·¯ä½¿ç”¨ç¦»æ•£å€¼ï¼Œè€Œç‰©ç†å€¼ä¸€èˆ¬æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥ç”µè·¯è®¾è®¡è€…è¦æƒ³åŠæ³•æŠŠç¦»æ•£å€¼å’Œè¿ç»­å€¼å¯¹åº”èµ·æ¥ã€‚\nä¾›ç”µç”µå‹ é›¶ä¼ç‰¹ç”µå‹ä¸€èˆ¬æŒ‡çš„æ˜¯æ¥åœ°ï¼ˆGNDï¼‰ã€‚ä»ä¸Šä¸–çºª 70 å¹´ä»£èµ·ï¼Œä¾›ç”µç”µå‹ä» 5V é™åˆ°äº† 1.2V ä»¥ä¸‹ã€‚\né€»è¾‘ç”µå¹³ é€»è¾‘ç”µå¹³æ˜¯æŒ‡æ•°å­—ç”µè·¯ä¸­ç”µä¿¡å·çš„ç”µå‹æ°´å¹³ï¼Œç”¨äºè¡¨ç¤ºé€»è¾‘çŠ¶æ€ã€‚åœ¨æ•°å­—ç”µè·¯ä¸­ï¼Œé€šå¸¸å°†ç”µå‹åˆ†ä¸ºä¸¤ä¸ªç¦»æ•£çš„çŠ¶æ€ï¼Œåˆ†åˆ«ä»£è¡¨é€»è¾‘å€¼ 0 å’Œé€»è¾‘å€¼ 1ã€‚\nå™ªå£°è£•åº¦ è¡¨ç¤ºå¯ä»¥å®¹å¿çš„ç”µå‹å·®å€¼ï¼š\n$$ NM_{L} = V_{IL} - V_{OL}$$ $$ NM_{H} = V_{OH} - V_{IH}$$\nç›´æµä¼ è¾“ç‰¹æ€§ å°†è¾“å…¥ç”µå‹ä½œä¸ºè‡ªå˜é‡ï¼Œå°†è¾“å‡ºç”µå‹ä½œä¸ºå› å˜é‡ï¼ŒæŠ½è±¡å‡ºä¸€ä¸ªå‡½æ•°ã€‚å…¶å½¢æˆçš„å›¾åƒå¾ˆæœ‰ç‰¹ç‚¹ï¼Œå«ä½œç›´æµä¼ è¾“ç‰¹æ€§ï¼ˆDC Transfer Characteristicsï¼‰ã€‚å›¾åƒè¯·å‚é˜…åŸä¹¦ã€‚\né™æ€ç”µè·¯æ³•åˆ™ é™æ€ç”µè·¯æ³•åˆ™è¦æ±‚ï¼Œåœ¨ç»™å®šé€»è¾‘ä¸Šæœ‰æ•ˆçš„è¾“å…¥æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç”µè·¯å…ƒä»¶éƒ½å°†äº§ç”Ÿé€»è¾‘ä¸Šæœ‰æ•ˆçš„è¾“å‡ºã€‚\nä¸ºäº†æé«˜ç”Ÿäº§åŠ›ï¼Œè¯ç”Ÿäº†å››ä¸ªé€»è¾‘å®¶æ—ï¼š\nTTL CMOS LVTTL LVCMOS ä¹ é¢˜ ","date":"2024-02-02T00:00:00Z","image":"https://kyocius.github.io/p/arch-book-1/header_hueaa4c8e5fd7a5595d1ecd775a7c5eb94_634924_120x120_fill_box_smart1_3.png","permalink":"https://kyocius.github.io/p/arch-book-1/","title":"æ•°ç”µä¸è®¡ç®—æœºä½“ç³»ç»“æ„ 01ï¼šå…¥é—¨"},{"content":"å‰è¨€ ç¬”è€…æ’°å†™æœ¬æ–‡æ—¶è¿˜åœ¨ä¸Šå¤§ä¸€ï¼Œæ•°æ®ç»“æ„åŸºç¡€å‡ ä¹ä¸ºé›¶ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€äº›å¯ç¬‘çš„é—®é¢˜å’Œä¸åˆæ—¶å®œçš„åæ§½ã€‚\næœ¬æ–‡å°è¯•è§£ç­”ä¹¦åé™„åŠ é¢˜ï¼Œæœ‰çš„ç« èŠ‚å¤ªç®€å•å°±ç•¥è¿‡äº†ã€‚\nç»ƒä¹ 10ï¼šå­—ç¬¦ä¸²æ•°ç»„å’Œå¾ªç¯ å¦‚ä½•ä½¿ç”¨ ,ï¼ˆé€—å·ï¼‰å­—ç¬¦æ¥åœ¨forå¾ªç¯çš„æ¯ä¸€éƒ¨åˆ†ä¸­ï¼Œ;ï¼ˆåˆ†å·ï¼‰ä¹‹é—´åˆ†éš”å¤šæ¡è¯­å¥ï¼Ÿ 1 for (i = 0, j = 10; i \u0026lt; 10; i++, j--) æŸ¥è¯¢ NULL æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œçœ‹çœ‹å®ƒä¼šæ‰“å°å‡ºä»€ä¹ˆï¼Ÿ åœ¨ C è¯­è¨€ä¸­ï¼ŒNULL æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œé€šå¸¸ç”¨äºè¡¨ç¤ºæŒ‡é’ˆä¸æŒ‡å‘ä»»ä½•æœ‰æ•ˆçš„å¯¹è±¡æˆ–åœ°å€ã€‚NULL çš„ç¡®åˆ‡å®šä¹‰å¯èƒ½å› ç¼–è¯‘å™¨å’Œå¹³å°è€Œå¼‚ï¼Œä½†é€šå¸¸å®ƒè¢«å®šä¹‰ä¸º (void *)0ï¼Œå³ä¸€ä¸ªè½¬æ¢ä¸º void æŒ‡é’ˆç±»å‹çš„é›¶å€¼ã€‚\nå½“ä½ å°è¯•æ‰“å°ä¸€ä¸ªæŒ‡å‘ NULLçš„æŒ‡é’ˆæ—¶ï¼Œç»“æœä¼šå–å†³äºä½ æ˜¯å¦‚ä½•æ‰“å°å®ƒçš„ã€‚åœ¨ C è¯­è¨€ä¸­ï¼Œå¦‚æœä½ ä½¿ç”¨ %p æ ¼å¼åŒ–æ ‡å¿—ï¼ˆç”¨äºæ‰“å°æŒ‡é’ˆåœ°å€ï¼‰å’Œ printf å‡½æ•°ï¼Œé€šå¸¸ä¼šæ‰“å°å‡ºä¸€ä¸ªè¡¨ç¤ºç©ºæŒ‡é’ˆçš„å€¼ï¼Œé€šå¸¸æ˜¯ (nil) æˆ–è€… 0x0ï¼Œå…·ä½“å–å†³äºç¼–è¯‘å™¨å’Œå¹³å°ã€‚\nçœ‹çœ‹ä½ æ˜¯å¦èƒ½åœ¨æ‰“å°ä¹‹å‰å°† states çš„ä¸€ä¸ªå…ƒç´ èµ‹å€¼ç»™ argv ä¸­çš„å…ƒç´ ï¼Œå†è¯•è¯•ç›¸åçš„æ“ä½œï¼Ÿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #include \u0026lt;stdio.h\u0026gt; int main(int argc, char *argv[]) { char *states[] = {\u0026#34;California\u0026#34;, \u0026#34;Oregon\u0026#34;, \u0026#34;Washington\u0026#34;, \u0026#34;Texas\u0026#34;}; // å°†statesçš„ä¸€ä¸ªå…ƒç´ èµ‹å€¼ç»™argvçš„ä¸€ä¸ªå…ƒç´  // æ³¨æ„ï¼šè¿™é€šå¸¸ä¸æ˜¯ä¸ªå¥½ä¸»æ„ï¼Œå› ä¸ºargvé€šå¸¸ä¸åº”è¢«ä¿®æ”¹ if (argc \u0026gt; 1) { argv[1] = states[0]; printf(\u0026#34;argv[1] is now %s\\n\u0026#34;, argv[1]); } // å°†argvçš„ä¸€ä¸ªå…ƒç´ èµ‹å€¼ç»™statesçš„ä¸€ä¸ªå…ƒç´  states[0] = argv[0]; printf(\u0026#34;states[0] is now %s\\n\u0026#34;, states[0]); return 0; } ç»ƒä¹ 16ï¼šç»“æ„ä½“å’ŒæŒ‡å‘å®ƒä»¬çš„æŒ‡é’ˆ å¦‚ä½•åœ¨æ ˆä¸Šåˆ›å»ºç»“æ„ä½“ï¼Œå°±åƒä½ åˆ›å»ºä»»ä½•å…¶å®ƒå˜é‡é‚£æ ·ï¼Ÿ å¦‚ä½•ä½¿ç”¨ x.y è€Œä¸æ˜¯ x-\u0026gt;y æ¥åˆå§‹åŒ–ç»“æ„ä½“ï¼Ÿ å¯¹äºå‰ä¸¤ä¸ªé—®é¢˜å…¶å®éå¸¸å¥½è§£ç­”ã€‚åªè¦æŠŠå˜é‡ x è®¾ç½®æˆéæŒ‡é’ˆå³å¯ã€‚\nå¦‚ä½•ä¸ä½¿ç”¨æŒ‡é’ˆæ¥å°†ç»“æ„ä½“ä¼ ç»™å…¶å®ƒå‡½æ•°ï¼Ÿ C è¯­è¨€ä¸å¯èƒ½ä¸ä½¿ç”¨æŒ‡é’ˆä¼ é€’ç»“æ„ä½“æœ¬èº«ã€‚æ‰€ä»¥è¿™é“é¢˜çš„æ„æ€å°±æµ…æ˜¾åœ°æŒ‡ï¼ŒæŠŠå‚æ•°çš„ * å»æ‰ä½ ä¼šä¸ä¼š\u0026hellip;\nè¯¦ç»†ä»£ç è¯·è§ï¼šGitHub\nç»ƒä¹ 17ï¼šå †å’Œæ ˆçš„å†…å­˜åˆ†é… å¯¹äºç°åœ¨ä½ ä»¬è¿™äº›å¹´è½»äººæ¥è¯´ï¼Œç¼–ç¨‹ç®€ç›´å¤ªå®¹æ˜“äº†ã€‚å¦‚æœä½ ç©ç© Ruby æˆ–è€… Python çš„è¯ï¼Œåªè¦åˆ›å»ºå¯¹è±¡æˆ–å˜é‡å°±å¥½äº†ï¼Œä¸ç”¨ç®¡å®ƒä»¬å­˜æ”¾åœ¨å“ªé‡Œã€‚\nç†æ¸…å†…å­˜æœ€ç®€å•åŸåˆ™ï¼šå¦‚æœä½ çš„å˜é‡å¹¶ä¸æ˜¯ä» malloc ä¸­è·å–çš„ï¼Œä¹Ÿä¸æ˜¯ä»ä¸€ä¸ªä» malloc è·å–çš„å‡½æ•°ä¸­è·å–çš„ï¼Œé‚£ä¹ˆå®ƒåœ¨æ ˆä¸Šã€‚\nstrncpy æœ‰ä»€ä¹ˆè®¾è®¡ç¼ºé™·ï¼Ÿ 1 char *strncpy(char *dest, const char *src, size_t n) strcpy å‡½æ•°ä¸ä¼šå‘ dest è¿½åŠ  \\0ï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²æ²¡æœ‰äº†ç»“æŸï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜éæ³•è®¿é—®ã€‚\nC å¦‚ä½•æ‰“åŒ…ç»“æ„ä½“ï¼Ÿç»“æ„ä½“æ·»åŠ ä¸€äº›å­—æ®µä¹‹åçš„æ–°å¤§å°ï¼Ÿ åœ¨ C è¯­è¨€ä¸­ï¼Œç»“æ„ä½“çš„é»˜è®¤å¯¹é½æ–¹å¼é€šå¸¸æ˜¯æŒ‰ç…§ç»“æ„ä½“æˆå‘˜ä¸­å ç”¨å†…å­˜æœ€å¤§çš„æ•°æ®ç±»å‹è¿›è¡Œå¯¹é½ã€‚è¿™è¢«ç§°ä¸ºâ€œæœ€å¤§æˆå‘˜å¯¹é½â€æˆ–â€œè‡ªç„¶å¯¹é½â€ã€‚\nç»“æ„ä½“çš„æ€»å¤§å°æ˜¯å…¶æœ€å¤§å¯¹é½æˆå‘˜çš„å¤§å°çš„æ•´æ•°å€ã€‚\nç»ƒä¹ 18ï¼šå‡½æ•°æŒ‡é’ˆ å‡½æ•°æŒ‡é’ˆç¼–å†™çªé—¨ï¼š\nç¼–å†™ä¸€ä¸ªæ™®é€šçš„å‡½æ•°å£°æ˜ï¼šint callme(int a, int b) å°†å‡½æ•°ç”¨æŒ‡é’ˆè¯­æ³•åŒ…è£…ï¼šint (*callme)(int a, int b) å°†åç§°æ”¹æˆæŒ‡é’ˆåç§°ï¼šint (*compare_cb)(int a, int b) æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ typedef æ¥ç®€åŒ–å‡½æ•°æŒ‡é’ˆä»¥ä¾¿äºä¼ å‚ï¼š\n1 typedef int (*compare_cb)(int a, int b) å¦‚æ­¤ï¼Œåœ¨å¦ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°±èƒ½å°† compare_cb ä½œä¸ºç±»å‹ä¼ é€’ï¼š\n1 int *bubble_sort(int *numbers, int count, compare_cb cmp) å°†é”™è¯¯çš„å‡½æ•°ä¼ ç»™ compare_cbï¼Œå¹¶çœ‹çœ‹ C ç¼–è¾‘å™¨ä¼šæŠ¥å‘Šä»€ä¹ˆé”™è¯¯ï¼Ÿ ç±»ä¼¼äº \u0026ldquo;assignment from incompatible pointer type\u0026rdquo; æˆ– \u0026ldquo;incompatible types in assignment\u0026rdquo; çš„é”™è¯¯æ¶ˆæ¯ã€‚\nå°† NULL ä¼ ç»™å®ƒï¼Œçœ‹çœ‹ç¨‹åºä¸­ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ç„¶åè¿è¡Œ Valgrind æ¥çœ‹çœ‹å®ƒä¼šæŠ¥å‘Šä»€ä¹ˆï¼Ÿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #include \u0026lt;stdio.h\u0026gt; void myFunction(int *ptr) { if (ptr != NULL) { // åœ¨è¿™é‡Œè§£å¼•ç”¨éç©ºæŒ‡é’ˆ *ptr = 42; } } int main() { int *nullPointer = NULL; // å°† NULL ä¼ é€’ç»™å‡½æ•°æŒ‡é’ˆ myFunction(nullPointer); return 0; } Valgrind çš„æŠ¥é”™ï¼š\n1 2 3 4 ==12345== Invalid write of size 4 ==12345== at 0x80484A7: myFunction (example.c:6) ==12345== by 0x80484F4: main (example.c:14) ==12345== Address 0x0 is not stack\u0026#39;d, malloc\u0026#39;d or (recently) free\u0026#39;d è¿™ä¸ªæŠ¥å‘Šè¡¨æ˜åœ¨ myFunction å‡½æ•°çš„ç¬¬ 6 è¡Œå‘ç”Ÿäº†ä¸€ä¸ªå°è¯•å†™å…¥å¤§å°ä¸º 4 çš„æ— æ•ˆå†…å­˜ã€‚\nç»ƒä¹ 32ï¼šåŒå‘é“¾è¡¨ å¼ºçƒˆå»ºè®® 0 æ•°æ®ç»“æ„åŸºç¡€å…ˆå»æ²¹ç®¡çœ‹ä¸€ä¸‹å°åº¦è€å“¥çš„åŒå‘é“¾è¡¨æ•™ç¨‹ï¼šYouTube\nå…ˆåœ¨å¤´æ–‡ä»¶ä¸­ç¼–å†™ä¸¤ä¸ªç»“æ„ä½“ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #include \u0026lt;stdlib.h\u0026gt; struct ListNode; typedef struct ListNode { struct ListNode *prev; struct ListNode *next; void *value; // å¯ä»¥æŒ‡å‘ä»»ä½•æ•°æ®ç±»å‹ } ListNode; typedef struct List { ListNode *first; ListNode *last; int count; } ç„¶åé¢„å®šä¹‰å››ä¸ª List çš„æ•´ä½“æ–¹æ³•ï¼š\n1 2 3 4 List *List_create(); void List_destroy(List *list); void List_clear(List *list); void List_clear_destroy(List *list); ä¸‰ä¸ªå®æ–¹æ³•ï¼ˆä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦ç”¨å®ï¼‰ï¼š\n1 2 3 4 5 #define List_count(A) ((A)-\u0026gt;count) #define List_first(A) ((A)-\u0026gt;first != NULL ? (A)-\u0026gt;first-\u0026gt;value : NULL) #define List_last(A) ((A)-\u0026gt;last != NULL ? (A)-\u0026gt;last-\u0026gt;value : NULL) æ¥ä¸‹æ¥é¢„å®šä¹‰æ•°æ®çš„æ“ä½œæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 void List_push(List *list, void *value); void *List_pop(List *list); // é“¾è¡¨çš„å¤´éƒ¨æ’å…¥ä¸åˆ é™¤ï¼Œå‘½åé£æ ¼æ¥è‡ªäº Perl è¯­è¨€ void List_unshift(List *list, void *value); void *List_shift(List *list); void *List_remove(List *list, ListNode *node); å®šä¹‰ LIST_FOREACH å®ã€‚ä¹¦ä¸­è¯´è¿™æ˜¯ä¸ªå¸¸è§çš„ä¹ è¯­ï¼š\n1 2 3 #define LIST_FOREACH(L, S, M, V) ListNode *_node = NULL; \\ ListNode *V = NULL;\\ for(V = _node = L -\u0026gt; S; _node != NULL; V = _node = _node -\u0026gt; M) è¿™ä¸ªå®åˆ©ç”¨äº†ä¸€ä¸ª for å¾ªç¯ï¼Œå…¶ä¸­ _node ç”¨äºè·Ÿè¸ªå½“å‰èŠ‚ç‚¹ï¼ŒV ç”¨äºè¡¨ç¤ºå½“å‰èŠ‚ç‚¹ã€‚åœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œ_node è¢«æ›´æ–°ä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»è€Œå®ç°é“¾è¡¨éå†çš„å°è£…ã€‚\nç°åœ¨å¼€å§‹å®ç°å¤´æ–‡ä»¶çš„æ–¹æ³•ã€‚åœ¨ list.c ä¸­å…ˆå®Œæˆ List çš„æ•´ä½“æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #include \u0026lt;lcthw/list.h\u0026gt; List *List_create() { return calloc(1, sizeof(List)); } void List_destroy(List *list) { LIST_FOREACH(list, first, next, cur) { if (cur-\u0026gt;prev) free(cur-\u0026gt;prev) } free(list-\u0026gt;last); free(list); } void List_clear(List *list) { LIST_FOREACH(list, first, next, cur) { free(cur-\u0026gt;value); } } void List_clear_destroy(List *list) { List_clear(list); List_destroy(list); } æ¥ä¸‹æ¥å®ç°æ•°æ®çš„æ“ä½œæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 void List_push(List *list, void *value) { ListNode *node = calloc(1, sizeof(ListNode)); check_mem(node); // è·³è½¬åˆ° error æ ‡ç­¾ node-\u0026gt;value = value; if(list-\u0026gt;last == NULL) { list-\u0026gt;first = node; list-\u0026gt;last = node; } else { list-\u0026gt;last-\u0026gt;next = node; node-\u0026gt;prev = list-\u0026gt;last; list-\u0026gt;last = node; } list-\u0026gt;count++; error: return; } void *List_pop(List *list) { ListNode *node = list-\u0026gt;last; return node != NULL ? List_remove(list, node) : NULL; } void List_unshift(List *list, void *value) { ListNode *node = calloc(1, sizeof(ListNode)); check_mem(node); node-\u0026gt;value = value; if(list-\u0026gt;first == NULL) { list-\u0026gt;first = node; list-\u0026gt;last = node; } else { node-\u0026gt;next = list-\u0026gt;first; list-\u0026gt;first-\u0026gt;prev = node; list-\u0026gt;first = node; } list-\u0026gt;count++; error: return; } void *List_shift(List *list) { ListNode *node = list-\u0026gt;first; return node != NULL ? List_remove(list, node) : NULL; } void *List_remove(List *list, ListNode *node) { void *result = NULL; check(list-\u0026gt;first \u0026amp;\u0026amp; list-\u0026gt;last, \u0026#34;List is empty.\u0026#34;); check(node, \u0026#34;node can\u0026#39;t be NULL\u0026#34;); if(node == list-\u0026gt;first \u0026amp;\u0026amp; node == list-\u0026gt;last) { list-\u0026gt;first = NULL; list-\u0026gt;last = NULL; } else if(node == list-\u0026gt;first) { list-\u0026gt;first = node-\u0026gt;next; check(list-\u0026gt;first != NULL, \u0026#34;Invalid list, somehow got a first that is NULL.\u0026#34;); list-\u0026gt;first-\u0026gt;prev = NULL; } else if (node == list-\u0026gt;last) { list-\u0026gt;last = node-\u0026gt;prev; check(list-\u0026gt;last != NULL, \u0026#34;Invalid list, somehow got a next that is NULL.\u0026#34;); list-\u0026gt;last-\u0026gt;next = NULL; } else { ListNode *after = node-\u0026gt;next; ListNode *before = node-\u0026gt;prev; after-\u0026gt;prev = before; before-\u0026gt;next = after; } list-\u0026gt;count--; result = node-\u0026gt;value; free(node); error: return result; } ç°åœ¨æˆ‘ä»¬ç»ˆäºå®ç°äº†åŒå‘é“¾è¡¨ä¸Šçš„æ‰€æœ‰æ“ä½œã€‚é—¹éº»äº†ï¼Œä¹¦ä¸Šçš„å®ç°æ–¹æ³•æ„Ÿè§‰è·Ÿå–‚äº† Poops ä¸€æ ·ã€‚\nç ”ç©¶åŒå‘å’Œå•å‘é“¾è¡¨ï¼Œä»¥åŠä»€ä¹ˆæƒ…å†µä¸‹å…¶ä¸­ä¸€ç§ä¼˜äºå¦ä¸€ç§ã€‚ å•å‘é“¾è¡¨å†…å­˜å°ï¼Œæ€§èƒ½å¥½ï¼›åŒå‘é“¾è¡¨åŠŸèƒ½å¼ºï¼Œæ¯”å¦‚é€†åºéå†ã€‚\nç ”ç©¶åŒå‘é“¾è¡¨çš„é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œè™½ç„¶å®ƒä»¬å¯¹äºæ’å…¥å’Œåˆ é™¤å…ƒç´ å¾ˆé«˜æ•ˆï¼Œä½†æ˜¯å¯¹äºå˜é‡å…ƒç´ æ¯”è¾ƒæ…¢ã€‚ åŒå‘é“¾è¡¨æ›´æ”¹ä¸€ä¸ªèŠ‚ç‚¹æ„å‘³ç€è¦ä¿®æ”¹ä¸¤ç«¯çš„èŠ‚ç‚¹ï¼Œè¿™å¤ªåœ°ç‹±äº†ã€‚\n","date":"2024-01-23T00:00:00Z","image":"https://kyocius.github.io/p/clang-review/head_hub4c439e7083278e8ec7df601f4a86ed3_945835_120x120_fill_box_smart1_3.png","permalink":"https://kyocius.github.io/p/clang-review/","title":"ç¬¨æ–¹æ³•å­¦ C é™„åŠ é¢˜ä¸å®Œå…¨è§£ç­”"},{"content":" æœ¬æ–‡ç¿»è¯‘è‡ªæ‰˜ç®¡åœ¨ GitHub ä¸Šçš„ 2fsharp å¼€æºé¡¹ç›®\nè¯‘ç‰ˆä»…å‘è¡¨åœ¨çŸ¥ä¹å’Œ æœ¬äººåšå®¢ ä¸Šï¼Œæœªç»æˆæƒç¦æ­¢è½¬è½½\nè¿™ä¸ªæ•™ç¨‹æ˜¯åŸºäºå®ä¾‹æ¥è®²è§£çš„ï¼Œå°†ä¼šèŠ±è´¹ä½  15-30 åˆ†é’Ÿçš„æ—¶é—´ã€‚\nä½ å°†ä¼šå­¦åˆ° F# è¿™é—¨è¯­è¨€ 80% çš„ç‰¹æ€§ï¼\nä¾‹ 1ï¼šåŸºæœ¬å‡½æ•°å£°æ˜ä¸å®ç° 1 2 3 4 5 6 7 public int GiveMeTheLength(string input) { // å•è¡Œæ³¨é‡Š var result = input.Length; /* å¤šè¡Œæ³¨é‡Š */ return result; } å˜æˆäº†\n1 2 3 4 5 let GiveMeTheLength(input) = // å•è¡Œæ³¨é‡Š let result = input.Length (* å¤šè¡Œæ³¨é‡Š *) result æ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯é»˜è®¤ä¸º public çš„ï¼Œé™¤éä½ æ˜¾å¼å£°æ˜ private ä¿®é¥°ç¬¦ã€‚ å…³é”®å­— var å˜æˆäº† letï¼ˆä¸ä»…ä»…ç”¨æ¥å£°æ˜å˜é‡ï¼Œè¿˜ç”¨æ¥å£°æ˜å‡½æ•°ï¼‰ã€‚ ä½ ä¸å†éœ€è¦ return å…³é”®å­—ã€‚å‡½æ•°çš„æœ€åä¸€è¡Œå°±æ˜¯è¿”å›å€¼ã€‚ ä¸å†éœ€è¦èŠ±æ‹¬å·ï¼Œä½¿ç”¨ 4 æ ¼ï¼ˆæˆ–è€… 2 æ ¼ï¼‰ç¼©è¿›ï¼Œå°±åƒ Python ä¸€æ ·ã€‚ ä¸å†éœ€è¦åˆ†å·æ¥æ ‡å¿—ä¸€è¡Œç»“æŸã€‚ ç±»å‹å£°æ˜æ˜¯å¯é€‰çš„ï¼Œé™¤äº†æå°‘æ•°æƒ…å†µç¼–è¯‘å™¨æ— æ³•æ¨æ–­ç±»å‹ã€‚ å•è¡Œæ³¨é‡Šå’Œ C# ç›¸åŒï¼Œä½†æ˜¯å¤šè¡Œæ³¨é‡Šä½¿ç”¨æ‹¬å·è€Œä¸æ˜¯æ–œæ ã€‚ å¦‚æœä½ æƒ³è¦å£°æ˜ç±»å‹ï¼Œéœ€è¦è¿™æ ·å†™ï¼š\n1 2 3 let GiveMeTheLength(input: string): int = let result: int = input.Length result ä¾‹ 2ï¼šåŸºæœ¬å…³é”®å­—å’Œæ“ä½œç¬¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 using System; class MainClass { void Main() { int exitCode = 0; if (incomingChar == Environment.NewLine) exitCode = 1; else if (!(incomingChar == String.Empty)) exitCode = 2; else if (incomingChar != \u0026#34;\\t\u0026#34; \u0026amp;\u0026amp; incomingChar.Length \u0026gt; 1) exitCode = 3; else exitCode = 4; Environment.Exit(exitCode); } } å˜æˆäº†\n1 2 3 4 5 6 7 8 9 10 11 12 open System let mutable exitCode: int = 0 if incomingChar = Environment.NewLine then exitCode \u0026lt;- 1 elif not (incomingChar = String.Empty) then exitCode \u0026lt;- 2 elif (incomingChar \u0026lt;\u0026gt; \u0026#34;\\t\u0026#34; \u0026amp;\u0026amp; incomingChar.Length \u0026gt; 1) then exitCode \u0026lt;- 3 else exitCode \u0026lt;- 4 Environment.Exit(exitCode) using å…³é”®å­—å˜æˆäº† open å…³é”®å­—ã€‚ if (x) foo(); else if (y) bar(); else baz(); æ¨¡å¼å˜æˆäº† if x then foo() elif y then bar() else baz()ï¼Œæ¡ä»¶è¯­å¥ä¹Ÿä¸å†éœ€è¦åœ†æ‹¬å·ã€‚ä½†æ˜¯ä½¿ç”¨äº†æ–°çš„å…³é”®å­— then å’Œ elifã€‚ åˆå§‹èµ‹å€¼ï¼ˆåªè¯»å¸¸é‡ï¼‰æ“ä½œç¬¦æ˜¯ =ã€‚å¦‚æœä½ éœ€è¦ä¸ºè¿™ä¸ªå…ƒç´ é‡æ–°èµ‹å€¼ï¼Œä½ éœ€è¦å°†å®ƒæ ‡è®°ä¸º mutable ç„¶åä½¿ç”¨ \u0026lt;- æ“ä½œç¬¦ã€‚ æ“ä½œç¬¦ = å˜æˆäº†æ¯”è¾ƒç¬¦ï¼ˆä¸å†éœ€è¦åƒ C# é‚£æ ·ä½¿ç”¨åŒç­‰å· == äº†ï¼‰ã€‚ æ“ä½œç¬¦ != å˜æˆäº† \u0026lt;\u0026gt;ã€‚ æ“ä½œç¬¦ ! å˜æˆäº† notã€‚ æ“ä½œç¬¦ \u0026amp;\u0026amp; å’Œ || åœ¨ F# ä¸å˜ã€‚ ä¸å†éœ€è¦æä¾› Main() æ–¹æ³•è¿™æ ·çš„å…¥å£å‡½æ•°, ç›´æ¥åœ¨ä¸€ä¸ª .fsx æ–‡ä»¶ä¸­ç¼–å†™é€»è¾‘æˆ–è€…ä½¿ç”¨æœ€æ–°çš„ .fs æ–‡ä»¶ä¸­ç¼–å†™è¯­å¥ä»¥æ»¡è¶³ F# ç¼–è¯‘å™¨è¦æ±‚ã€‚ é€šå¸¸ï¼Œä¸Šé¢çš„ä»£ç å…¶å®ä¸éœ€è¦ä½¿ç”¨ mutableï¼Œå°±åƒå¦‚ä¸‹å†™æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 open System let exitCode = if incomingChar = Environment.NewLine then 1 elif not (incomingChar = String.Empty) then 2 elif (incomingChar \u0026lt;\u0026gt; \u0026#34;\\t\u0026#34; \u0026amp;\u0026amp; incomingChar.Length \u0026gt; 1) then 3 else 4 Environment.Exit(exitCode) ï¼ˆè¿™å’Œ C# ä¸­çš„ä¸‰å…ƒæ“ä½œç¬¦ç±»ä¼¼ï¼Œä½†æ˜¯å¯è¯»æ€§æ›´é«˜ï¼‰\nä¾‹ 3ï¼šåŸºç¡€é›†åˆ 1 2 3 4 5 6 7 var intArray = new int[] { 1, 2, 3 }; var intList = new List\u0026lt;int\u0026gt;({ 4, 5, 6 }); IEnumerable\u0026lt;int\u0026gt; sequenceOfIntegers = intList; var dictionary = new Dictionary\u0026lt;int,string\u0026gt;() { { \u0026#34;One\u0026#34;, 1 }, { \u0026#34;Two\u0026#34;, 2 } } å˜æˆäº†å¦‚ä¸‹ä»£ç ï¼ˆå…¶å®ä½ ä¸éœ€è¦å£°æ˜ç±»å‹ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿æ•™å­¦ï¼‰ï¼š\n1 2 3 4 let intArray: array\u0026lt;int\u0026gt; = [| 1; 2; 3 |] let intList: List\u0026lt;int\u0026gt; = [ 4 ; 5 ; 6 ] let sequenceOfIntegers: seq\u0026lt;int\u0026gt; = intList let dictionary: IDictionary\u0026lt;string,int\u0026gt; = dict [ (\u0026#34;One\u0026#34;, 1); (\u0026#34;Two\u0026#34;, 2) ] å£°æ˜ Array/List/Dictionary æ—¶ï¼Œé€—å·å˜æˆäº†åˆ†å·ã€‚ IEnumerable\u0026lt;T\u0026gt; å˜æˆäº† seq\u0026lt;'T\u0026gt;ï¼ˆSequence çš„ç¼©å†™ï¼‰ã€‚ ä½ ä½¿ç”¨ä¸€ä¸ª dict æ¥åˆå§‹åŒ–ä¸€ä¸ªIDictionary\u0026lt;K,V\u0026gt; é›†åˆï¼Œä½†æ˜¯åœ¨ F# ä¸­ä½ å°†ä¼šæ›´å€¾å‘äºä½¿ç”¨ Map\u0026lt;'K,'V\u0026gt; å› ä¸ºå®ƒæ˜¯å¯å˜çš„ã€‚ ä½ å¯èƒ½ä¹Ÿæ³¨æ„åˆ°äº†ï¼Œæ³›å‹ç±»å‹éœ€è¦ä¸€ä¸ªå‰ç¼€å•å¼•å·ã€Œ\u0026rsquo;ã€\nä¾‹ 4ï¼šä»£ç å— 1 2 3 4 5 6 7 8 9 10 11 try { TrySomething(someParam); } catch (SomeException ex) { if (SomeCondition(ex)) { DoSomethingElse(ex); throw new OtherException(); } else throw; } finally { MakeSureToCleanup(someParam); } å˜æˆäº†\n1 2 3 4 5 6 7 8 9 10 11 12 13 try try TrySomething(someParam) with | :? SomeException as ex -\u0026gt; if SomeCondition(ex) then DoSomethingElse(ex) raise OtherException else reraise() finally MakeSureToCleanup(someParam) catch å˜æˆäº† with å…³é”®å­—ã€‚ throw X; è¯­å¥å˜æˆäº† raise Xï¼Œç„¶å throw; å˜æˆäº†è°ƒç”¨ reraise() å‡½æ•°ã€‚ ä½†æ˜¯ï¼Œæ²¡æœ‰ try-with-catch å—ï¼F# åªæœ‰ try-with å’Œ try-finally å—ã€‚æ‰€ä»¥æˆ‘ä»¬åªèƒ½ç”¨ä¸¤ä¸ª try åµŒå¥—ã€‚ ä½ å¯èƒ½ä¼šæƒ³ï¼Œè¿™æ˜¯ F# çš„ç¼ºé™·ï¼Œä½†å…¶å®å®Œæ•´çš„ try-catch-finally å—å¾ˆå°‘ç”¨ï¼Œå°¤å…¶æ˜¯æœ‰äº† using å…³é”®å­—ï¼š\n1 2 3 4 using (var reader = new StreamReader(someFile)) { DoStuff(reader); } è¿™å˜æˆäº†\n1 2 use reader = new StreamReader(someFile) DoStuff(reader) ä½¿ç”¨ use å°±ä¸å†éœ€è¦åµŒå¥—ä»£ç å—äº†ã€‚ èµ„æºä¼šè‡ªåŠ¨é‡Šæ”¾ï¼ˆå’Œ C# çš„ using ç›¸åŒï¼‰ã€‚ ä¾‹ 5ï¼šé¿å… Null å’Œå¿½ç•¥ 1 2 3 4 5 6 7 8 void Check(SomeType someParam1, SomeType someParam2) { if (someParam1 != null) stringBuilder.Append(someParam1.ToString()); if (someParam2 != null) stringBuilder.Append(String.Empty); } å˜æˆäº†\n1 2 3 4 5 6 7 8 9 10 11 12 let Check(someParam1: Option\u0026lt;SomeType\u0026gt;, someParam2: Option\u0026lt;SomeType\u0026gt;): unit = match someParam1 with | Some(someValue) -\u0026gt; // like \u0026#39;as\u0026#39; in C#, you cast and want the value let str = someValue.ToString() ignore(stringBuilder.Append(str)) | None -\u0026gt; () match someParam2 with | Some(_) -\u0026gt; // like \u0026#39;is\u0026#39; in C#, you don\u0026#39;t care about the value stringBuilder.Append(String.Empty) |\u0026gt; ignore | _ -\u0026gt; () åœ¨ C# ä¸­ä½ ç»å¸¸ä¼šåˆ°å¤„å†™åˆ¤ç©ºæ£€æŸ¥ï¼ˆæ²¡æœ‰ç¼–è¯‘æ—¶å®‰å…¨ï¼‰ã€‚åœ¨ F# ä¸­ï¼Œä½ å°†ä½¿ç”¨æ›´å®‰å…¨çš„ Option\u0026lt;T\u0026gt; ç±»å‹ï¼ˆä¸Nullable\u0026lt;T\u0026gt; ç±»ä¼¼ä½†æ˜¯æ›´æ£’ï¼‰å’Œ match è¡¨è¾¾å¼ï¼ˆæ¨¡å¼åŒ¹é…ï¼‰ã€‚\nå½“ä½ ä¸æƒ³è¿”å›ä»»ä½•ä¸œè¥¿æ—¶ï¼Œåœ¨ C# ä½ ä¼šå†™ void è¡¨ç¤ºæ²¡æœ‰å£°æ˜ç±»å‹ã€‚ä½†æ˜¯åœ¨ F# ä¸­ä½ éœ€è¦è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ç±» unitï¼Œå®ƒçš„é»˜è®¤å€¼ä¸º ()ã€‚ ä¸€ä¸ª match-with ä»£ç å—åŸºæœ¬ä¸Šå’Œ switch ä»£ç å—ç±»ä¼¼ï¼Œä½†æ˜¯æ›´åŠ ç®€æ´æ˜äº†ï¼Œå› ä¸ºå®ƒåŒ…å«äº† Castingï¼ˆSomeValueï¼‰ è¿™é‡Œæœ‰ä¸‰ä¸ªæ–¹å¼æ¥å®ç°å¿½ç•¥ï¼š æ¯”æ–¹è¯´ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒ Append() å‡½æ•°çš„è¿”å›å€¼ï¼Œåœ¨ C# ä¸­æˆ‘ä»¬å°±ç›´æ¥å¿½ç•¥ï¼Œä½†æ˜¯åœ¨ F# ä¸­æˆ‘ä»¬éœ€è¦æ˜¾å¼åœ°å¿½ç•¥å®ƒï¼Œä½¿ç”¨ ignore() è¿™ä¸ªé­”æ³•æ–¹æ³•ã€‚ Match è¡¨è¾¾å¼çš„ä¸‹åˆ’çº¿ï¼šå®ƒå°±åƒ C# çš„ switch ä¸­çš„ default åˆ†æ”¯ã€‚ åœ¨ Some(_) ä¸­çš„ä¸‹åˆ’çº¿è¡¨ç¤ºï¼Œæˆ‘ä»¬æƒ³ä¿è¯ä¸€ä¸ªå€¼ä¸æ˜¯ç©ºï¼Œä½†æˆ‘ä»¬åˆä¸å…³å¿ƒå®ƒçš„å…·ä½“å€¼ï¼ˆå°±åƒ C# ä¸­çš„ is æ“ä½œç¬¦ï¼‰ã€‚ ç®¡é“æ“ä½œç¬¦ï¼šignore(x) ä¸ x |\u0026gt; ignore ç­‰ä»·ã€‚ ä¾‹ 6ï¼šç±»å‹ ä¸‹é¢è¿™ä¸ªç±»ä½¿ç”¨ F# å°±ç®€å•å¾ˆå¤šã€‚\nï¼ˆè¯‘è€…æ³¨ï¼šå…¶å®å¯ä»¥ä½¿ç”¨ C# 6.0 çš„è‡ªåŠ¨å®Œæˆå±æ€§æˆ–è€… C# 9.0 çš„è®°å½•ç±»ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public class Foo { public Foo (int bar, string baz) { this.bar = bar; this.baz = baz; } readonly int bar; public int Bar { get { return bar; } } readonly string baz; public string Baz { get { return baz; } } } static class FooFactory { static internal Foo CreateFoo() { return new Foo(42, \u0026#34;forty-two\u0026#34;); } } åœ¨ F# ä¸­å°±ä¸€è¡Œï¼š\n1 2 3 4 5 type Foo = { Bar: int; Baz: string } module FooFactory = let internal CreateFoo () = { Bar = 42; Baz = \u0026#34;forty-two\u0026#34; } ç”±æ­¤å¯è§:\næ²¡æœ‰åŠ¨ä½œè¡Œä¸ºçš„ç±»ï¼ˆå°±åƒä¸Šé¢çš„ Foo ç±»ï¼‰å«ä½œã€Œè®°å½•ç±» Recordã€ï¼Œé•¿å¾—åƒ C# çš„ç»“æ„ä½“ä½†æ˜¯å®ƒä»¬ä¾ç„¶æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¹¶ä¸”è¢«ä¿å­˜åœ¨å †ä¸Šã€‚è®°å½•ç±»æ˜¯ä¸å¯å˜çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ä½ åˆ›å»ºå®ƒä»¬ï¼Œå°±ä¸èƒ½å†ä¿®æ”¹å®ƒä»¬çš„å€¼äº†ã€‚ é™æ€ç±»å˜æˆäº†ã€Œmodulesã€ï¼Œå¦‚ä¸Š FooFactory ç±»ã€‚ åœ¨ F# ä¸­ï¼Œä¸éœ€è¦ä½¿ç”¨ new å…³é”®å­—ï¼Œé™¤éè¿™ä¸ªç±»å®ç°äº† IDisposable æ¥å£ã€‚ ä¾‹ 7ï¼šå‡½æ•°çš„é¡ºåºå¾ˆé‡è¦ï¼Œå¾ªç¯ä¾èµ–æ˜¯ä¸‡æ¶ä¹‹æº ä½œä¸º C# å¼€å‘è€…ï¼Œä½ å½“ç„¶çŸ¥é“ä¸‹é¢çš„ä»£ç å¯ä»¥é€šè¿‡ç¼–è¯‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 static class Foo { static void Bar() { if (Baz()) Bar(); } static bool Baz() { return false; } } ç†æ‰€åº”å½“ï¼ä¸‹é¢çš„ä»£ç ä¹Ÿå¯ä»¥é€šè¿‡ç¼–è¯‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 static class Foo1 { public static void Bar() { } static void Baz() { Foo2.Baz(); } } static class Foo2 { static void Bar() { Foo1.Bar(); } public static void Baz() { } } ä¹Ÿè®¸ä½ æ˜ç™½æˆ‘è¯´åˆ°å“ªé‡Œäº†ã€‚\nåä¸€æ®µ C# ä»£ç å¯ä»¥é€šè¿‡ç¼–è¯‘ï¼Œæ˜¯å› ä¸º C# å…è®¸å¾ªç¯ä¾èµ–ï¼ˆCircular Dependenciesï¼‰ã€‚\nä½†æ˜¯è¿™å¥è¯åŠå¯¹åŠé”™ï¼Œå› ä¸ºåœ¨ C# ä¸­å¾ªç¯ä¾èµ–æ˜¯åˆæ³•çš„ï¼Œä½†æ˜¯åœ¨ .NET ç¨‹åºé›†é‡Œä¸åˆæ³•ã€‚å¦‚æœç¨‹åºé›† A ä¾èµ–äºç¨‹åºé›† Bï¼Œä½ ä¸èƒ½ä» A å¼•ç”¨ Bã€‚\nè¿™ä¸ªæ¨¡å—æ€§åŸåˆ™å°†ä¼šé˜»æ­¢ä½ å†™å‡ºä¸Šé¢çš„ä»£ç ï¼Œå› ä¸ºåœ¨æœªæ¥ä½ å°†ä¸èƒ½å°†å®ƒä»¬åˆ†ä¸ºä¸¤ä¸ªç¨‹åºé›†ï¼ˆä½ ä¸èƒ½å°† Foo1 æ”¾è¿›ä¸€ä¸ªç¨‹åºé›†é‡Œï¼Œç„¶åæŠŠ Foo2 æ”¾è¿›å¦ä¸€ä¸ªç¨‹åºé›†ï¼Œå› ä¸ºåœ¨ .NET ä¸­è¿™å¹¶ä¸åˆæ³•ï¼‰ã€‚\nä¹‹åï¼Œä½ éœ€è¦äº†è§£çš„æ˜¯ï¼Œåœ¨ F# ä¸­ï¼Œå³ä½¿åœ¨åŒä¸€ç¨‹åºé›†é‡Œï¼Œå¾ªç¯ä¾èµ–ä¹Ÿä¸åˆæ³•ï¼\né€šè¿‡å¼ºåˆ¶ä½ åœ¨ç±»å‹ B ä¹‹å‰å£°æ˜ ç±»å‹ Aï¼Œé˜²æ­¢ä½ åœ¨ä¹‹åçš„å‡½æ•°ä¸­è°ƒç”¨å‰é¢çš„å‡½æ•°æ—¶å‡ºé”™ã€‚\nå› æ­¤ï¼Œä¸‹é¢çš„ F# ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 module Foo1 = let Bar() = () let Baz() = Foo2.Baz() module Foo2 = let Bar() = Foo1.Bar() let Baz() = () ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ¥çœ‹çœ‹å®ƒçš„æŠ¥é”™ï¼š\nError FS0039: The value, namespace, type or module \u0026lsquo;Foo2\u0026rsquo; is not defined. (Referring to Foo1.Baz implementation.) è¿™ä¸ªæŠ¥é”™æ˜¯ä¸èƒ½ä¿®å¤çš„ï¼Œé™¤éæˆ‘ä»¬ç›´æ¥åœæ­¢ä½¿ç”¨å¾ªç¯ä¾èµ–ã€‚\nï¼ˆè¿˜æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚ä½¿ç”¨ via å’Œ rec å…³é”®å­—ï¼Œä½†æ˜¯åœ¨æœ¬æ•™ç¨‹ä¸­å¹¶ä¸ä¼šè®²è§£ï¼Œå› ä¸ºå¤ªé«˜çº§äº†ï¼‰\nF# ç¼–è¯‘å™¨ä¸¥æ ¼é™åˆ¶äº†æˆ‘ä»¬ä¸èƒ½å¾ªç¯ä¾èµ–ï¼Œè¿™æ„å‘³ç€å¦‚æœå‡½æ•° A è°ƒç”¨äº†å‡½æ•° Bï¼Œé‚£ä¹ˆå‡½æ•° B å°±å¿…é¡»åœ¨ A ä¹‹å‰å£°æ˜\nï¼ˆå¦‚æœè¿™ä¸¤ä¸ªå‡½æ•°åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆå‡½æ•° B å°±æ˜¯åœ¨å‡½æ•° A ä¸Šé¢ï¼›å¦‚æœè¿™ä¸¤ä¸ªå‡½æ•°åœ¨åŒä¸€ F# å·¥ç¨‹ä¸‹ä¸åŒæ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆ B.fs å¿…é¡»æ¯” A.fs æ—©åˆ—å‡ºï¼‰\nå› æ­¤ï¼Œä¸‹é¢çš„ä»£ç ä¹Ÿä¸ä¼šé€šè¿‡ç¼–è¯‘ï¼š\n1 2 3 4 5 6 7 module Foo = let Bar() = if Baz() then Bar() let Baz(): bool = false å®ƒæŠ›å‡ºäº†å¦‚ä¸‹é”™è¯¯ï¼š\nError FS0039: The value or constructor \u0026lsquo;Baz\u0026rsquo; is not defined. (Referring to Foo.Bar implementation.) Error FS0039: The value or constructor \u0026lsquo;Bar\u0026rsquo; is not defined. (Referring to Foo.Bar implementation.) æ­£å¦‚æˆ‘ä»¬åˆšåˆšå­¦åˆ°çš„ï¼Œè¿™æ›´å®¹æ˜“è§£å†³ï¼›åªè¦å…ˆå£°æ˜ Baz å³å¯ã€‚\nè€Œä¸ºäº†è®©ä¸€ä¸ªå‡½æ•°èƒ½å¤Ÿè°ƒç”¨è‡ªå·±ï¼ˆåœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå¾ªç¯ä¾èµ–ï¼‰ï¼Œæˆ‘ä»¬ä½¿ç”¨ rec å…³é”®å­—ï¼ˆæ„æ€å°±æ˜¯ã€Œé€’å½’ã€)ï¼š\n1 2 3 4 5 6 7 module Foo = let Baz(): bool = false let rec Bar() = if Baz() then Bar() ä¾‹ 8ï¼šå§”æ‰˜ã€åŒ¿åå‡½æ•°Â·Â·Â·æˆ‘çš„è€å¤©çˆ·ï¼ åœ¨ C# çš„æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œéœ€è¦é€šè¿‡å§”æ‰˜ç±»å‹å’ŒåŒ¿åå‡½æ•°ä¼ é€’å‡½æ•°ã€‚è¯·çœ‹ä¸‹é¢æœ‰ 4 ç§ç»„åˆçš„ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 static class SomeOldCsharpClass { delegate void ProcedureWithNoReturnValueAndNoArguments(); static void DelegateReception1(ProcedureWithNoReturnValueAndNoArguments dlg) { dlg.Invoke(); } static void SendingAnonymousMethodAsDelegate1() { DelegateReception1(delegate () { Console.WriteLine(\u0026#34;hello 1\u0026#34;); }); } delegate void ProcedureWithNoReturnValueAndOneArg(string foo); static void DelegateReception2(ProcedureWithNoReturnValueAndOneArg dlg) { string bar = \u0026#34;baz\u0026#34;; dlg.Invoke(bar); } static void SendingAnonymousMethodAsDelegate2() { DelegateReception2(delegate (string foo) { Console.WriteLine(\u0026#34;hello 2 \u0026#34; + foo); }); } delegate int FunctionWithOneReturnValueAndNoArguments(); static void DelegateReception3(FunctionWithOneReturnValueAndNoArguments dlg) { int result = dlg.Invoke(); } static void SendingAnonymousMethodAsDelegate3() { DelegateReception3(delegate () { Console.WriteLine(\u0026#34;hello 3\u0026#34;); return 3; }); } delegate long FunctionWithOneReturnValueAndOneArg(double foo); static void DelegateReception4(FunctionWithOneReturnValueAndOneArg dlg) { double bar = 4.0; long result = dlg.Invoke(bar); } static void SendingAnonymousMethodAsDelegate4() { DelegateReception4(delegate (double foo) { Console.WriteLine(\u0026#34;hello 4 \u0026#34; + foo); return 4; }); } } ä½†åæ¥æ–°ç‰ˆæœ¬çš„ C# å‡ºç°äº†æ›´ä¼˜é›…çš„æ–¹å¼ï¼ˆå¾—ç›Šäºå±€éƒ¨å‡½æ•°ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 static class SomeNewCsharpClass { static void SendingAnonymousMethodAsDelegate1() { void DelegateReception1(Action dlg) { dlg.Invoke(); } DelegateReception1(() =\u0026gt; { Console.WriteLine(\u0026#34;hello 1\u0026#34;); }); } static void SendingAnonymousMethodAsDelegate2() { void DelegateReception2(Action\u0026lt;string\u0026gt; dlg) { string bar = \u0026#34;baz\u0026#34;; dlg.Invoke(bar); } DelegateReception2((string foo) =\u0026gt; { Console.WriteLine(\u0026#34;hello 2 \u0026#34; + foo); }); } static void SendingAnonymousMethodAsDelegate3() { void DelegateReception3(Func\u0026lt;int\u0026gt; dlg) { int result = dlg.Invoke(); } DelegateReception3(() =\u0026gt; { Console.WriteLine(\u0026#34;hello 3\u0026#34;); return 3; }); } static void SendingAnonymousMethodAsDelegate4() { void DelegateReception4(Func\u0026lt;double, long\u0026gt; dlg) { double bar = 4.0; long result = dlg.Invoke(bar); } DelegateReception4((double foo) =\u0026gt; { Console.WriteLine(\u0026#34;hello 4 \u0026#34; + foo); return 4; }); } } æœ€æœ‰è¶£çš„æ”¹è¿›å°±æ˜¯ .NET é¢„å®šä¹‰çš„ Action å’Œ Func ç±»å‹ï¼Œä»¥åŠ Lambda è¡¨è¾¾å¼ã€‚\nå¥½æ¶ˆæ¯æ˜¯åœ¨ F# ä¸­ï¼Œå‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ã€‚å› æ­¤ä»£ç æ›´åŠ ç®€å•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 module SomeFsharpModule = let SendingAnonymousMethodAsDelegate1() = let DelegateReception1(dlg: unit-\u0026gt;unit) = dlg() DelegateReception1(fun _ -\u0026gt; Console.WriteLine(\u0026#34;hello 1\u0026#34;) ) let SendingAnonymousMethodAsDelegate2() = let DelegateReception2(dlg: string-\u0026gt;unit) = let bar = \u0026#34;baz\u0026#34; dlg(bar) DelegateReception2(fun bar -\u0026gt; Console.WriteLine(\u0026#34;hello 2 \u0026#34; + bar) ) let SendingAnonymousMethodAsDelegate3() = let DelegateReception3(dlg: unit-\u0026gt;int) = let result = dlg() () DelegateReception3(fun _ -\u0026gt; Console.WriteLine(\u0026#34;hello 3\u0026#34;) 3 ) let SendingAnonymousMethodAsDelegate4() = let DelegateReception4(dlg: double-\u0026gt;int64) = let bar = 4.0 let result = dlg(bar) () DelegateReception4(fun bar -\u0026gt; Console.WriteLine(\u0026#34;hello 4 \u0026#34; + bar.ToString()) int64(4) ) æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼ŒBCL çš„ System.Function å’Œ System.Action å˜æˆäº†åŸç”Ÿ F# è¯­æ³•ã€‚\né€šè¿‡ -\u0026gt; ç¬¦å·æ¥è¡¨ç¤ºå‚æ•°å’Œè¿”å›å€¼ï¼Œä¾‹å¦‚ TArg1-\u0026gt;TResultã€‚è¯·è®°ä½ï¼Œvoid åœ¨ F# ä¸­æ˜¯ unitã€‚\nåŒæ ·é‡è¦çš„æ˜¯ï¼ŒC# çš„ (...) =\u0026gt; { ... } å˜æˆäº† fun ... -\u0026gt; ...\nä¾‹ 9ï¼šå…ƒç»„ã€å±€éƒ¨åº”ç”¨ä»¥åŠæŸ¯é‡ŒåŒ– å¦‚æœä½ æ²¡æœ‰åšè¿‡å‡½æ•°å¼ç¼–ç¨‹ï¼Œä½ å¯èƒ½ä¼šå¯¹å…¶ä¸­çš„ä¸€äº›æ¦‚å¿µæ„Ÿåˆ°å®³æ€•ï¼Œæ¯”å¦‚ã€Œå±€éƒ¨åº”ç”¨ Partial Applicationã€ã€ŒæŸ¯é‡ŒåŒ– Currificationã€ã€‚\nä½†äº‹å®æ˜¯ï¼Œå®ƒä»¬å¹¶ä¸æ˜¯é‚£ä¹ˆå¤æ‚çš„æ¦‚å¿µã€‚ä¸ºäº†æ­£ç¡®è§£é‡Šå®ƒä»¬ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè§£é‡Šå…ƒç»„ï¼Œä»¥åŠä¸ºä»€ä¹ˆä¸å»ºè®®åœ¨ F# ä¸­æ»¥ç”¨å®ƒä»¬ã€‚\nï¼ˆäº‹å®ä¸Šï¼Œä½ ä¸èƒ½ç”¨å…ƒç»„æ¥ä½¿ç”¨å±€éƒ¨åº”ç”¨ï¼ç¨åå°†è¯¦ç»†ä»‹ç»ï¼‰\nè®©æˆ‘ä»¬å…ˆçœ‹çœ‹ä¸‹é¢è¿™æ®µä½¿ç”¨ out å‚æ•°çš„ C# ä»£ç ï¼š\n1 2 3 4 5 6 int anInteger; if (int.TryParse(someString, out anInteger)) { DoSomethingWithAnInteger(anInteger); } else { DoSomethingElse(); } å¦‚æœä½ å°è¯•å°†ä¸Šé¢çš„ C# ä»£ç è½¬è¯‘æˆ F#ï¼Œä½ é¦–å…ˆä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼šæˆ‘ä»¬æ€æ ·å£°æ˜ä¸€ä¸ªå˜é‡ä½†ä¸ç»™å®ƒèµ‹å€¼å‘¢ï¼Ÿç›¸ä¿¡æˆ‘ï¼ŒF# æ˜¯ä¸å¯èƒ½åšåˆ°çš„ã€‚\nä½ å¯èƒ½ä¼šæƒ³åˆ°å…ˆéšä¾¿ç»™å˜é‡ anInteger èµ‹ä¸€ä¸ªå€¼ï¼Œåæ­£æœ€åä¼šè¢« TryParse() æ–¹æ³•è¦†å†™ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼ä¸å¤Ÿä¼˜é›…ï¼Œå°¤å…¶æ˜¯æŠŠå˜é‡æ ‡è®°ä¸º mutableï¼Œä¸ç¬¦åˆ F# çš„è¯­è¨€ä¹ æƒ¯ã€‚\næœ€å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨ã€Œç§¯ææ¨¡å¼ Acitve Patternã€â€”â€”å°†ä¸Šé¢å¤šä¸ªå‡½æ•°è½¬æ¢æˆä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”åŒæ—¶è™šæ‹Ÿåœ°è¿”å›ä¸¤ä¸ªå€¼ï¼š\n1 2 3 match int.TryParse(someString) with | (true, anInteger) -\u0026gt; DoSomethingWithAnInteger(anInteger) | (false, _) -\u0026gt; DoSomethingElse() ç§¯ææ¨¡å¼ä¸º F# ç¼–è¯‘å™¨æä¾›äº†è¯­æ³•ç³–ï¼Œå°† bool TryParse(string,out int) è½¬æ¢æˆäº†ç±»ä¼¼ (bool,int) TryParse(string) çš„å‡½æ•°ï¼Œè€Œ (bool,int) æ˜¯ä¸€ä¸ªå…ƒç»„ï¼\næ‰€ä»¥åœ¨ F# ä¸­ï¼Œåˆ›å»ºä»»æ„é•¿åº¦çš„å…ƒç»„æ˜¯å¾ˆå®¹æ˜“çš„äº‹æƒ…ï¼Œä¸éœ€è¦ä½¿ç”¨ System.Tuple\u0026lt;X,Y,...\u0026gt;ã€‚\nè¿™è®©æˆ‘æƒ³èµ·äº†æ–°ç‰ˆæœ¬ C# å¯¹äºå…ƒç»„çš„æ”¹è¿›â€”â€”ä½ å¯ä»¥åœ¨å‡½æ•°çš„ç­¾åé‡Œä½¿ç”¨å…ƒç»„è€Œä¸éœ€è¦ç”¨ Tupleã€‚\næ¥æ£€æŸ¥ä¸€ä¸‹æˆ‘è¯´çš„æ˜¯ä»€ä¹ˆæ„æ€å§ã€‚è¿™æ˜¯ C# çš„è€å¼å†™æ³•ï¼š\n1 2 3 4 5 6 7 8 bool ReceiveTuple(Tuple\u0026lt;string,int\u0026gt; aTuple) { var counter = aTuple.Item2++; Console.WriteLine(aTuple.Item1); var newTuple = new Tuple\u0026lt;string,int\u0026gt;(aTuple.Item1, counter) ReceiveTuple(newTuple); return true; } å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªå˜é‡æŒ‡å‘è¿™ä¸ªå‡½æ•°ï¼Œå®ƒçš„ç±»å‹å°±åº”æ˜¯ Func\u0026lt;Tuple\u0026lt;string,int\u0026gt;,bool\u0026gt;ã€‚\næ–°å¼çš„ C# å†™æ³•ï¼ˆä¼šè¢«ç¼–è¯‘æˆ ValueTuple\u0026lt;X,Y,...\u0026gt;ï¼‰ï¼š\n1 2 3 4 5 6 7 8 bool ReceiveTuple((string str, int i) aTuple) { var counter = aTuple.i++; Console.WriteLine(aTuple.str); var newTuple = (aTuple.str, counter); ReceiveTuple(newTuple); return true; } ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæŒ‡å‘è¿™ä¸ªå‡½æ•°çš„å˜é‡ï¼Œå®ƒçš„ç±»å‹æ˜¯ Func\u0026lt;ValueTuple\u0026lt;string,int\u0026gt;,bool\u0026gt;ã€‚\nä½¿ç”¨ F#ï¼š\n1 2 3 4 5 6 let rec ReceiveTuple(str: string, i: int) = let counter = i + 1 Console.WriteLine(str) let newTuple = (str, counter) ReceiveTuple (newTuple) true åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¼•ç”¨è¿™ä¸ªå‡½æ•°çš„ F# ç±»å‹æ˜¯ string*int-\u0026gt;boolï¼›æ‰€ä»¥æˆ‘ä»¬å­¦åˆ°äº†ä¸€ä¸ªæ–°çš„ç¬¦å·ï¼šæ˜Ÿå·ã€Œ*ã€åœ¨å…¶å®ƒè¯­è¨€é‡Œä»£è¡¨æŒ‡é’ˆï¼Œä½†åœ¨ F# ä¸­å®ƒåªæ˜¯å…ƒç»„ä¸­ç±»å‹çš„åˆ†éš”ç¬¦ã€‚\nä½ æ˜¯å¦æ³¨æ„åˆ°å…ƒç»„æ˜¯å¦‚ä½•èå…¥åˆ° F# ä¸­é‚£äº›çœ‹ä¼¼æ­£å¸¸çš„å‚æ•°ä¸­çš„ï¼Ÿäº‹å®ä¸Šï¼Œæœ¬æŒ‡å—åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬åœ¨ F# ä¸­å†™çš„æ‰€æœ‰æ¥æ”¶å¤šå‚çš„å‡½æ•°ï¼Œå®é™…ä¸Šéƒ½åœ¨ä½¿ç”¨å…ƒç»„ã€‚ä¸ç”¨å…ƒç»„èƒ½åœ¨ F# ä¸­å†™å‡ºçš„ä¸Šè¿°æ–¹æ³•å—ï¼Ÿå½“ç„¶å¯ä»¥ï¼Œåªæ˜¯çœç•¥äº†é€—å·ï¼š\n1 2 3 4 5 let rec ReceiveNonTuple (str: string) (i: int) = let counter = i + 1 Console.WriteLine(str) ReceiveNonTuple str counter true å‡½æ•° ReceiveTuple å’Œ ReceiveNonTuple ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸¤è€…éƒ½æ¥æ”¶ç›¸åŒæ•°é‡çš„å‚æ•°ï¼Œå¹¶ä¸”å…·æœ‰ç›¸åŒçš„ç±»å‹ã€‚ä½†æ˜¯ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯ F# å…ƒç»„ï¼Œè€Œç¬¬äºŒä¸ªå‡½æ•°çš„å‚æ•°åˆ™æ˜¯ä»¥ F# è¯­è¨€æƒ¯ç”¨æ–¹å¼å£°æ˜çš„ï¼ˆä»¥ã€ŒæŸ¯é‡ŒåŒ–ã€çš„å½¢å¼ï¼‰ã€‚\nä¸ºä»€ä¹ˆåè€…åœ¨ F# ä¸­æ›´ç¬¦åˆè¯­è¨€ä¹ æƒ¯ï¼Ÿå› ä¸º ReceiveTuple ä¸èƒ½ç”¨äºå±€éƒ¨åº”ç”¨ï¼Œè€ŒReceiveNonTuple å¯ä»¥ï¼Œå› ä¸ºå®ƒä½¿ç”¨çš„æ˜¯ã€ŒæŸ¯é‡ŒåŒ–ã€é£æ ¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°çš„ç±»å‹ä¸æ˜¯ string*int-\u0026gt;boolï¼Œè€Œæ˜¯ (string-\u0026gt;int)-\u0026gt;boolã€‚\né‚£ä¸ºä»€ä¹ˆ (string-\u0026gt;int)-\u0026gt;bool æ¯” string*int-\u0026gt;bool æ›´å¥½å‘¢ï¼Ÿ\nåè€…å…è®¸ä¸ C# çš„äº’æ“ä½œï¼ˆå› ä¸ºè¿™æ˜¯ä»¥ CIL çº§åˆ«ä¼ é€’å‚æ•°çš„æ–¹å¼ï¼‰ï¼Œä½†å‰è€…å…è®¸ä»¥éå¸¸ç›´æ¥å’Œç®€æ´çš„æ–¹å¼è¿›è¡Œå±€éƒ¨åº”ç”¨ï¼ˆæˆ‘ä»¬å°†åœ¨åé¢çœ‹åˆ°ï¼Œéƒ¨åˆ†åº”ç”¨åœ¨ C# ä¸­ä¹Ÿæ˜¯å¯èƒ½çš„ï¼Œä½†æ–¹å¼éå¸¸å¤æ‚ï¼Œå¯è¯»æ€§/ç»´æŠ¤æ€§å¾ˆå·®ï¼‰ã€‚\nå› æ­¤ï¼Œä¸å†å¤šè¯´ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¸€ä¸ªéå¸¸ç®€å•çš„éƒ¨åˆ†åº”ç”¨çš„ä¾‹å­ã€‚å‡è®¾æˆ‘ä»¬æƒ³åˆ›å»ºä¸€ä¸ªä¹˜æ³•å‡½æ•°ï¼Œæ¥æ”¶ä¸¤ä¸ªæ•´æ•°å¹¶è¿”å›ä¸€ä¸ªæ•´æ•°ï¼š\n1 2 let Multiply (x: int) (y: int): int = x * y ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å†™ä¸€ä¸ªå‡½æ•°å°†ä¸€ä¸ªæ•°å­—çš„å€¼å¢åŠ ä¸€å€ï¼Œè€Œä¸éœ€è¦é‡å¤ä¹˜æ³•å‡½æ•°çš„ä»»ä½•å®ç°ç»†èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°è¿™æ ·å†™ï¼š\n1 2 let Double (x: int): int = Multiply 2 å½“æˆ‘ä»¬åªå‘å‡½æ•° Multiply ä¼ é€’ä¸€ä¸ªå‚æ•°æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\nè®©æˆ‘ä»¬çœ‹çœ‹å®ƒçš„åŸå§‹ç­¾åï¼š(int-\u0026gt;int)-\u0026gt;intã€‚ã€ŒæŸ¯é‡Œæ³•åˆ™ã€å‘Šè¯‰æˆ‘ä»¬ï¼Œåœ¨ç±»å‹è¡¨è¾¾å¼ä¸­ä½¿ç”¨å°æ‹¬å·å®é™…ä¸Šæ˜¯ä¸éœ€è¦çš„ï¼ˆæˆ–è€…æŠŠå®ƒä»¬æ”¾åœ¨å…¶ä»–åœ°æ–¹ä¼šå¾—åˆ°ä¸€ä¸ªç­‰ä»·çš„è¡¨è¾¾å¼ï¼‰ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™æ ·å†™ int-\u0026gt;int-\u0026gt;int æˆ–è€…è¿™æ ·å†™ int-\u0026gt;ï¼ˆint-\u0026gt;intï¼‰ã€‚å› æ­¤ï¼Œå‘ä¸€ä¸ªåŸæœ¬æ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„å‡½æ•°åªä¼ é€’ä¸€ä¸ªå‚æ•°ï¼Œå®é™…ä¸Šä¼šå¯¼è‡´è¿”å›å¦ä¸€ä¸ªå‡½æ•°ã€‚\næˆ‘ä»¬å¯ä»¥è¿™æ ·æ›´å¥½åœ°ç†è§£å®ƒï¼š\n1 2 3 4 let Double (x: int): int = let doubleFunc = Multiply 2 let result = doubleFunc x result æˆ–è€…è¿™æ ·ï¼ˆå†—é•¿çš„ç±»å‹å£°æ˜ï¼‰ï¼š\n1 2 3 4 let Double (x: int): int = let doubleFunc: int-\u0026gt;int = Multiply 2 let result: int = doubleFunc x result è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­ï¼Œä¹Ÿè®¸èƒ½è®©ä½ æ˜ç™½å±€éƒ¨åº”ç”¨çš„å¼ºå¤§ä¹‹å¤„ã€‚ä½†å®ƒæ˜¯å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ä¾èµ–æ³¨å…¥ç­‰æ“ä½œçš„åŸºç¡€ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œä½ å¯èƒ½åªä¼šæŒæ¡å®ƒæ‰€å¸¦æ¥çš„çµæ´»æ€§ï¼Œä½†è‡³å°‘æˆ‘ä»¬å·²ç»å¯ä»¥å‘ä½ å±•ç¤ºå®ƒåœ¨ F# ä¸­çš„ç®€å•æ€§ã€‚åœ¨ C# ä¸­ï¼Œæˆ‘ä»¬åªèƒ½è¿™æ ·æ¥å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 static Func\u0026lt;int, Func\u0026lt;int, int\u0026gt;\u0026gt; Multiply() { return (x) =\u0026gt; { (y) =\u0026gt; { x * y; }; }; } static Function\u0026lt;int,int\u0026gt; Double() { return Multiply().Invoke(2); } static int Main() { var someInt = 3; return Double().Invoke(someInt); } ä½ çš„å¤§è„‘èƒ½è½¬è¿‡å¼¯å„¿æ¥å—ï¼Ÿå¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ¯”é˜…è¯» F# ä»£ç éš¾ç†è§£å¤šäº†ã€‚\nå…³äºå±€éƒ¨åº”ç”¨åŠå…¶ç”¨å¤„çš„æœ€åè¯´æ˜ï¼šä½ ä½¿ç”¨ F# çš„æ—¶é—´è¶Šé•¿ï¼Œä½ å°±ä¼šæ„è¯†åˆ°å±€éƒ¨åº”ç”¨å®é™…ä¸Šæ˜¯ä¸€ç§ç®€åŒ–çš„ä¾èµ–æ³¨å…¥/æ§åˆ¶åè½¬ï¼ˆDI / IoCï¼‰æ–¹å¼ï¼Œè¯¦è§ã€Šå±€éƒ¨åº”ç”¨å°±æ˜¯ä¾èµ–æ³¨å…¥ã€‹ä¸€æ–‡ã€‚\nä¾‹ 10ï¼šå­—ç¬¦ä¸²æ’å€¼ åœ¨æ—©æœŸçš„ C# ç‰ˆæœ¬ä¸­ï¼Œä½ éœ€è¦è¿™æ ·å†™ï¼š\n1 var aStringToShowToTheUser = String.Format(\u0026#34;Hello {0}, I see you are {1} years old\u0026#34;, name, age); è¿™æœ‰ä¸¤ä¸ªé—®é¢˜ï¼šåœ¨å¤§å‹ä»£ç åº“ä¸­ï¼Œè®¸å¤šå˜é‡å’Œå…ƒç´ è¢«åŒ…å«åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œæˆ‘ä»¬ç´¢å¼•äº†ä¸€ä¸ªæ²¡æœ‰æä¾›çš„å˜é‡ï¼ˆä¾‹å¦‚ {2}ï¼‰å¾ˆå®¹æ˜“å‘ç”Ÿï¼Œæˆ–è€…æˆ‘ä»¬æä¾›çš„å˜é‡æ²¡æœ‰éšå¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚\nåœ¨ F# ä¸­æ˜¯è¿™æ ·çš„ï¼š\n1 let aStringToShowToTheUser = sprintf \u0026#34;Hello %s, I see you are %i years old\u0026#34; name age å“ªä¸ªæ›´å¥½ï¼Ÿ\nå¦‚æœä½ æä¾›çš„å‚æ•°å°‘äºï¼ˆæˆ–å¤šäºï¼‰åœ¨å­—ç¬¦ä¸²ä¸­æ’å€¼æ‰€éœ€çš„å‚æ•°ï¼Œä½ å°†å¾—åˆ°ä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶å‡ºç°å¼‚å¸¸ã€‚ ä½ éœ€è¦é€šè¿‡ % åé¢çš„å­—æ¯æ¥æŒ‡å®šå­—ç¬¦ä¸²ä¸­å…ƒç´ çš„ç±»å‹ï¼Œå¦‚æœå®ƒä¸ä¸ºåŒä¸€ä½ç½®æä¾›çš„å…ƒç´ çš„ç±»å‹ä¸åŒ¹é…ï¼Œé‚£ä¹ˆä½ ä¼šå¾—åˆ°ä¸€ä¸ªç¼–è¯‘å™¨é”™è¯¯ï¼ˆè€Œä¸æ˜¯ä¸€ä¸ªæ— ç”¨çš„å…ƒç´ å­—ç¬¦ä¸²è¡¨ç¤ºï¼‰ã€‚ ä½ éœ€è¦æ›´å°‘çš„å°æ‹¬å·ï¼ˆå‚è§æœ¬æŒ‡å—ä¸­çš„æœ€åä¸€ä¸ªä¾‹å­ï¼‰ã€‚ ä¾‹ 11ï¼šå¼‚æ­¥ä»£ç  ä¸€æ®µç®€å•çš„ C# å¼‚æ­¥ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 static class MainClass { public class Toast { public bool IsYummy() { return true; } } static async Task\u0026lt;Toast\u0026gt; ToastBreadAsync() { var task = Task.Run(() =\u0026gt; new Toast() ); return await task; } static void ApplyButter(Toast toast) { /* TODO */ } static void ApplyJam(Toast toast) { /* TODO */ } static async Task\u0026lt;Toast\u0026gt; MakeToastWithButterAndJamAsync() { var toast = await ToastBreadAsync(); ApplyButter(toast); ApplyJam(toast); return toast; } public static async Task Main(string[] args) { Console.WriteLine(\u0026#34;Hello World!\u0026#34;); var toast = await MakeToastWithButterAndJamAsync(); Console.WriteLine(\u0026#34;Bye World!\u0026#34; + toast.IsYummy()); } } } åœ¨ F# ä¸­å˜æˆäº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 type Toast() = member this.IsYummy() = true let ToastBread(): Async\u0026lt;Toast\u0026gt; = async { return Toast() } let ApplyButter(toast) = () //TODO let ApplyJam(toast) = () //TODO let MakeToastWithButterAndJam() = async { let! toast = ToastBread() ApplyButter(toast) ApplyJam(toast) return toast } [\u0026lt;EntryPoint\u0026gt;] let main(argv) = Console.WriteLine(\u0026#34;Hello World!\u0026#34;) let toast = MakeToastWithButterAndJam() |\u0026gt; Async.RunSynchronously Console.WriteLine (\u0026#34;Bye world!\u0026#34; + (toast.IsYummy().ToString())) 0 // return an integer exit code å…³é”®ä¸åŒç‚¹ï¼š\nåœ¨ C# ä¸­ï¼Œå½“ä½ è°ƒç”¨ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•æ—¶ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ª Task\u0026lt;T\u0026gt; å¯¹è±¡ï¼Œå®ƒä»£è¡¨æ­£åœ¨è¿›è¡Œçš„å·¥ä½œï¼Œå¹¶ä¸”å·²ç»è¢«å¯åŠ¨ã€‚ä½†åœ¨ F# ä¸­ï¼ŒJob æ˜¯ç”±ä¸€ä¸ª Async\u0026lt;'T\u0026gt; å¯¹è±¡è¡¨ç¤ºçš„ï¼Œå®ƒè¿˜æ²¡æœ‰è¢«å¯åŠ¨ï¼ˆä½ å¯ä»¥åœ¨ä¹‹åå†³å®šå¦‚ä½•å¯åŠ¨å®ƒï¼›ä¾‹å¦‚ï¼Œåœ¨ä¸Šé¢ä¾‹å­ä¸­ï¼Œå®ƒç”¨ Async.RunSynchronously æ¥å¯åŠ¨ï¼‰ã€‚ åœ¨ F# çš„ let è¯­å¥åé¢åŠ ä¸ŠæƒŠå¹å· ! ç­‰ä»·äº C# çš„ awaitã€‚ åœ¨ C# ä¸­ï¼Œä½ å°†è®¡ç®—é‡å¤§çš„åŒæ­¥æ–¹æ³•åŒ…è£…åœ¨ Task.Run() ä¸­ï¼Œå°†å…¶è½¬æ¢ä¸ºå¼‚æ­¥æ–¹æ³•ã€‚åœ¨ F# ä¸­ï¼Œä½ åªéœ€ç”¨ async{} å—ï¼ˆä¸€ä¸ªè®¡ç®—è¡¨è¾¾å¼ï¼‰æ¥åŒ…è£…å®ƒä»¬ã€‚ å¦‚æœæˆ‘ä»¬ç¨å¾®æ”¹å˜ä¸Šé¢çš„ C# ä»£ç ï¼Œå¼•å…¥éæ³›å‹ Task å¯¹è±¡å’Œå¹¶è¡ŒåŒ–ï¼ˆå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªçƒ¤é¢åŒ…æœºï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 public class Ingredients { } public class Toast { public Toast(Ingredients i) { } } static async Task\u0026lt;Toast\u0026gt; ToastBreadAsync(Ingredients i) { var task = Task.Run(() =\u0026gt; new Toast(i) ); return await task; } static async Task\u0026lt;Toast[]\u0026gt; Make2ToastsAsync(Ingredients i) { var toast1 = ToastBreadAsync(i); var toast2 = ToastBreadAsync(i); return await Task.WhenAll(toast1, toast2); } static async Task MakeToastsAsync() { var i = await GatherIngredients(); await Make2ToastsAsync(i); } public static async Task\u0026lt;Ingredients\u0026gt; GatherIngredients() { return await Task.FromResult(new Ingredients()); } public static async Task Main(string[] args) { Console.WriteLine(\u0026#34;Hello World!\u0026#34;); await MakeToastsAsync(); Console.WriteLine(\u0026#34;Bye World!\u0026#34;); } åœ¨ F# ä¸­ï¼Œè¿™å˜æˆäº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 type Ingredients () = class end type Toast (i: Ingredients) = class end let ToastBread(i): Async\u0026lt;Toast\u0026gt; = async { return Toast(i) } let GatherIngredients () = async { return Ingredients() } let Make2Toasts(i) = async { let twoJobs: List\u0026lt;Async\u0026lt;Toast\u0026gt;\u0026gt; = [ToastBread(i); ToastBread(i)] let! _ = Async.Parallel(twoJobs) return () } let MakeToasts() = async { let! i = GatherIngredients() do! Make2Toasts(i) } [\u0026lt;EntryPoint\u0026gt;] let main(argv) = Console.WriteLine(\u0026#34;Hello World!\u0026#34;) MakeToasts() |\u0026gt; Async.RunSynchronously Console.WriteLine(\u0026#34;Bye world!\u0026#34;) 0 // return an integer exit code æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼š\nåœ¨ C# ä¸­å¤„ç†éæ³›å‹ Taskï¼Œåœ¨ F# ä¸­æ„å‘³ç€ä½¿ç”¨ unit ä½œä¸º Async çš„æ³›å‹å‚æ•°ï¼šAsync\u0026lt;unit\u0026gt;ã€‚ä¸è¦ä½¿ç”¨ let! x = ...ï¼Œä½ åªéœ€è¦ do!ã€‚ Task.WhenAll çš„ç­‰ä»·ç‰©æ˜¯ Async.Parallelã€‚ ä¾‹ 12ï¼šç¼–å†™æ›´å°‘ç¬¦å·ï¼Œæå‡ F# è„šæœ¬çš„å¯é˜…è¯»æ€§ï¼ ç›¸ä¿¡ä½ å·²ç»æ˜ç™½äº† F# ä¸­å…ƒç»„å’ŒæŸ¯é‡ŒåŒ–å‚æ•°çš„åŒºåˆ«ã€‚åè€…æ›´æ¨èä½¿ç”¨ã€‚\nä½ å¯èƒ½æ˜ç™½ï¼Œå†™è¿™ä¹ˆå¤šå°æ‹¬å·å…¶å®åªæ˜¯ä¸ºäº†æ˜ å°„å…ƒç»„ä¸­çš„ä¸œè¥¿ã€‚äº‹å®ä¸Šï¼Œè¿™æ˜¯åˆšä» C# è½¬åˆ° F# çš„æ€ç»´æƒ¯æ€§ã€‚\nF# çš„ç®€æ´ä¹‹å¤„ï¼š\næ²¡æœ‰é‚£ä¹ˆå¤šçš„æ‹¬å·ï¼Œå› ä¸ºä½ ä¸å†ä½¿ç”¨å…ƒç»„äº†ã€‚ ä¸éœ€è¦ä½¿ç”¨åˆ†å·ï¼Œå¦‚æœä½ åªä½¿ç”¨ EOL åˆ†éš”ç¬¦ã€‚ ä¸éœ€è¦ä½¿ç”¨å¤§æ‹¬å·ï¼ˆåœ¨ F# ä¸­å¤„ç†è®°å½•ç±»å‹æ—¶æ‰éœ€è¦å®ƒä»¬ï¼‰ã€‚ è®© F# ç¼–è¯‘å™¨æ¨æ–­ç±»å‹ï¼Œå°±ä¸éœ€è¦å¤šæ¬¡ä½¿ç”¨å†’å· :ã€‚ æ›´å¤šåœ°ä½¿ç”¨ç®¡é“è¿ç®—ç¬¦ |\u0026gt;ï¼Œä»¥é¿å…åœ¨ä¸€å¤§ä¸²ä»£ç çš„å³è¾¹è¿˜è¦å†™ä¸€å †å°æ‹¬å·ã€‚ åœ¨ F# ä¸­çš„ if è¡¨è¾¾å¼ä¸­ä¸éœ€è¦å°æ‹¬å·ï¼ˆä¸ C# ç›¸åï¼‰ã€‚ æœ‰äº†è¿™äº›è¦ç‚¹ï¼Œæˆ‘ä»¬æ¥é‡å†™ä¹‹å‰çš„æ‰€æœ‰ F# å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 open System let exitCode = if incomingChar = Environment.NewLine then 1 elif not (incomingChar = String.Empty) then 2 elif incomingChar \u0026lt;\u0026gt; \u0026#34;\\t\u0026#34; \u0026amp;\u0026amp; incomingChar.Length \u0026gt; 1 then 3 else 4 Environment.Exit exitCode 1 2 3 4 5 6 7 8 9 10 11 let intArray = [| 1 2 3 |] let intList = [ 4 5 6 ] let sequenceOfIntegers = intList let dic = dict [ (\u0026#34;One\u0026#34;, 1) (\u0026#34;Two\u0026#34;, 2) ] 1 2 3 4 5 6 7 8 9 10 11 12 13 try try TrySomething someParam with | :? SomeException as ex -\u0026gt; if SomeCondition ex then DoSomethingElse ex raise OtherException else reraise() finally MakeSureToCleanup someParam 1 2 use reader = new StreamReader someFile DoStuff reader 1 2 3 4 5 6 7 8 9 10 11 12 let Check someParam1 someParam2 = match someParam1 with | Some someValue -\u0026gt; // like \u0026#39;as\u0026#39; in C#, you cast and want the value let str = someValue.ToString() stringBuilder.Append str |\u0026gt; ignore | None -\u0026gt; () match someParam2 with | Some _ -\u0026gt; // like \u0026#39;is\u0026#39; in C#, you don\u0026#39;t care about the value stringBuilder.Append String.Empty |\u0026gt; ignore | _ -\u0026gt; () 1 2 3 4 5 6 7 8 type Foo = { Bar: int Baz: string } module FooFactory = let internal CreateFoo () = { Bar = 42 Baz = \u0026#34;forty-two\u0026#34; } 1 2 3 4 5 6 7 module Foo = let Baz() = false let rec Bar() = if Baz() then Bar() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 module SomeFsharpModule = let SendingAnonymousMethodAsDelegate1() = let DelegateReception1 dlg = dlg() DelegateReception1(fun _ -\u0026gt; Console.WriteLine \u0026#34;hello 1\u0026#34; ) let SendingAnonymousMethodAsDelegate2() = let DelegateReception2 dlg = let bar = \u0026#34;baz\u0026#34; dlg bar DelegateReception2(fun bar -\u0026gt; Console.WriteLine(\u0026#34;hello 2 \u0026#34; + bar) ) let SendingAnonymousMethodAsDelegate3() = let DelegateReception3 dlg = let result = dlg() () DelegateReception3(fun _ -\u0026gt; Console.WriteLine \u0026#34;hello 3\u0026#34; 3 ) let SendingAnonymousMethodAsDelegate4() = let DelegateReception4 dlg = let bar = 4.0 let result = dlg bar () DelegateReception4(fun bar -\u0026gt; Console.WriteLine(\u0026#34;hello 4 \u0026#34; + bar.ToString()) int64 4 ) 1 2 3 match int.TryParse someString with | true, anInteger -\u0026gt; DoSomethingWithAnInteger anInteger | false, _ -\u0026gt; DoSomethingElse() 1 2 3 4 5 let rec ReceiveNonTuple str i = let counter = i + 1 Console.WriteLine str ReceiveNonTuple str counter true 1 2 3 4 5 6 7 let Multiply x y = x * y let Double x = let doubleFunc = Multiply 2 let result = doubleFunc x result 1 let aStringToShowToTheUser = sprintf \u0026#34;Hello %s, I see you are %i years old\u0026#34; name age 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 type Ingredients () = class end type Toast (i: Ingredients) = class end let ToastBread i: Async\u0026lt;Toast\u0026gt; = async { return Toast i } let GatherIngredients () = async { return Ingredients() } let Make2Toasts i = async { let twoJobs: List\u0026lt;Async\u0026lt;Toast\u0026gt;\u0026gt; = [ToastBread i; ToastBread i] let! _ = Async.Parallel twoJobs return () } let MakeToasts() = async { let! i = GatherIngredients() do! Make2Toasts i } [\u0026lt;EntryPoint\u0026gt;] let main argv = Console.WriteLine \u0026#34;Hello World!\u0026#34; MakeToasts() |\u0026gt; Async.RunSynchronously Console.WriteLine \u0026#34;Bye world!\u0026#34; 0 // return an integer exit code ç¥è´ºä½ ! ä½ å­¦ä¹ äº†è¶³å¤Ÿçš„çŸ¥è¯†ï¼Œå¤§æ¦‚å¯ä»¥ç†è§£ 80% çš„ F# ä»£ç äº†ã€‚\næˆ–è€…è¯´ 80% çš„ç®€å• F# ä»£ç ï¼Œä¹Ÿå°±æ˜¯å¤§å¤šæ•° F# è„šæœ¬ä¸­æ‰€ä½¿ç”¨çš„ã€‚\næˆ‘å¯ä»¥å‘ä½ è§£é‡Šå¦‚ä½•åœ¨ F# ä¸­å»ºç«‹ç›¸å½“äºç±»ï¼ˆæœ‰è¡Œä¸ºã€æ„é€ å‡½æ•°ã€å±æ€§ï¼‰æˆ–ç»“æ„ï¼ˆå€¼ç±»å‹å’Œå †æ ˆåˆ†é…ï¼‰ä½†æ˜¯ï¼š\nè¿™äº›ä¸æ˜¯ F# çš„æƒ¯ç”¨å†™æ³• å¤§å¤šæ•°è„šæœ¬ç”šè‡³ä¸éœ€è¦ç±»å‹ï¼Œå®ƒä»¬åªéœ€è¦å‡½æ•°ã€å€¼å’Œè°ƒç”¨ï¼ˆå¦‚æœä½ æŠŠ F# å½“è„šæœ¬ç”¨ï¼‰ æ— è®ºå¦‚ä½•ï¼Œæˆ‘å»ºè®®ä¸‹ä¸€æ­¥ï¼š\nè§‚çœ‹è¿™ä¸ª è®²åº§ çœ‹çœ‹è¿™ç¯‡ æ–‡ç«  å¦‚æœè¿‡äº†ä¸€æ®µæ—¶é—´ï¼Œä½ è¿˜åœ¨ä¸ºä» C# è½¬æ¢è‡³ F# è€ŒæŒ£æ‰ï¼Œä¹Ÿå¯ä»¥æ—¶ä¸æ—¶åœ°ä½¿ç”¨è¿™ä¸ª å·¥å…·ã€‚\n","date":"2022-08-26T00:00:00Z","image":"https://kyocius.github.io/p/fsharp-for-csharp-devs/head_hu7ae8c9477ae0a68f34fbf9d5a3829117_280528_120x120_fill_box_smart1_3.png","permalink":"https://kyocius.github.io/p/fsharp-for-csharp-devs/","title":"å†™ç»™ C# å¼€å‘è€…çš„ F# å…‰é€Ÿå…¥é—¨æ•™ç¨‹"},{"content":"å‰è¨€ å°±æ˜¯å¤ªä¹…æ²¡å†™å¼‚æ­¥ï¼Œæœ‰çš„ç”¨æ³•å¿˜äº†ã€‚æ‰€ä»¥å†™ç¯‡åšå®¢å›é¡¾ä¸€ä¸‹ã€‚\nå¤§é‡å‚è€ƒã€ŠC# 10 in a Nutshellã€‹\nçº¿ç¨‹ Thread è™½ç„¶åœ¨ C# ä¸­ Task çš„ä½¿ç”¨é¢‘ç‡è¿œè¶…ç›´æ¥ä½¿ç”¨çº¿ç¨‹ï¼Œä½†æ˜¯æœ‰å…³çº¿ç¨‹çš„æ¦‚å¿µè¿˜æ˜¯è¦å¤ä¹ ä¸€ä¸‹çš„ã€‚\næ‰ä¸æ˜¯å› ä¸ºæˆ‘å…¨å¿˜äº†\nåˆ›å»ºçº¿ç¨‹ Create a Thread 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 using System; using System.Threading; var t = new Thread(WriteY); t.Start(); for (var i = 0; i \u0026lt; 1000; i++) { Console.Write(\u0026#34;x\u0026#34;); } void WriteY() { for (var i = 0; i \u0026lt; 1000; i++) Console.Write(\u0026#34;y\u0026#34;); } //è¾“å‡ºï¼š xxxxxxxxxxxxxyyyyyyyyyyyyyyyyyyyyy... xxxxxxxxxxxxxxxxxxxxxxxxxyyyyyyyyy... xxxxxxxxxxxxxxxxyyyyyyyyyyyyyyyyyy... yyyyyyyyyxxxxxxxxxxxxxxxxxxxxxxxxx... æˆ‘ä»¬å¯ä»¥é€šè¿‡ Name å±æ€§æ¥è®¿é—®çº¿ç¨‹çš„åå­—ï¼š\n1 WriteLine(Thread.CurrentThread.Name); Join ä¸ Sleep ä½ å¯ä»¥ä½¿ç”¨ Join æ–¹æ³•æ¥ç­‰å¾…çº¿ç¨‹ç»“æŸï¼š\n1 2 3 4 5 6 Thread t = new Thread(Go); t.Start(); t.Join(); Console.WriteLine(\u0026#34;çº¿ç¨‹tç»“æŸ\u0026#34;); void Go() { for (var i = 0; i \u0026lt; 1000; i++) Console.Write(\u0026#34;y\u0026#34;); } è¿™æ®µä»£ç ä¼šæ‰“å° y 1000 æ¬¡ç„¶åæ‰ä¼šè¾“å‡º çº¿ç¨‹tç»“æŸã€‚\nä¸‹é¢æ˜¯ Sleep çš„ç”¨æ³•ï¼š\n1 2 Thread.Sleep(TimeSpan.FromHours(1)); //ç¡ä¸€å°æ—¶ Thread.Sleep(500) //ç¡500æ¯«ç§’ ç‰¹æ®Šçš„æ˜¯ï¼š\nThread.Sleep(0) å¯ä»¥æ”¾å¼ƒå½“å‰çº¿ç¨‹ï¼Œä¸»åŠ¨å°† CPU ç§»äº¤ç»™å…¶å®ƒçº¿ç¨‹ã€‚\nThread.Yield() æ–¹æ³•ä½œç”¨ç±»ä¼¼ï¼Œåªæ˜¯ç§»äº¤ç›¸åŒçš„å¤„ç†å™¨ã€‚\né˜»å¡çº¿ç¨‹ Blocking æŸ¥è¯¢é˜»å¡çŠ¶æ€ï¼š\n1 bool isBlocked = (someThread.ThreadState \u0026amp; ThreadState.WaitSleepJoin) != 0; ThreadState æ˜¯ä¸€ä¸ª flags æšä¸¾ã€‚\nI/O å¯†é›†å‹ \u0026amp; è®¡ç®—å¯†é›†å‹ Bound ä¸¤è€…æ˜¯ C# å¹¶å‘ä¸­éå¸¸é‡è¦çš„æ¦‚å¿µã€‚\nç­‰å¾…äº‹ä»¶å‘ç”Ÿçš„æ“ä½œå«ä½œ I/O å¯†é›†å‹ï¼ˆI/O-boundï¼‰ å ç”¨ CPU æ¥å¤„ç†æ•°æ®å«è®¡ç®—å¯†é›†å‹ï¼ˆCompute-boundï¼‰ å±€éƒ¨å˜é‡ \u0026amp; å…±äº«çŠ¶æ€ Local \u0026amp; Shared State CLR ä¼šåˆ†é…ç»™æ¯ä¸ªçº¿ç¨‹ä¸åŒçš„å†…å­˜æ ˆï¼Œæ‰€ä»¥æŸä¸€çº¿ç¨‹çš„å±€éƒ¨å˜é‡æ˜¯ä¸å…¶å®ƒçº¿ç¨‹éš”ç»çš„ï¼š\n1 2 3 4 5 6 7 new Thread (Go).Start(); // åœ¨æ–°çº¿ç¨‹è°ƒç”¨Goæ–¹æ³• Go(); // åœ¨ä¸»çº¿ç¨‹è°ƒç”¨Goæ–¹æ³• void Go() { //å±€éƒ¨å˜é‡cycles for (int cycles = 0; cycles \u0026lt; 5; cycles++) Console.Write (\u0026#39;?\u0026#39;); } ç»“æœå¯æƒ³è€ŒçŸ¥ï¼Œä¼šè¾“å‡º 10 ä¸ªé—®å·ã€Œ?ã€ã€‚\nä½†æ˜¯çº¿ç¨‹å¯ä»¥å…±äº«æ•°æ®ï¼šå¦‚æœå®ƒä»¬æœ‰å¯¹åŒä¸€å¯¹è±¡æˆ–å˜é‡çš„å¼•ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 bool _done = false; new Thread (Go).Start(); Go() ; void Go() { if (!_done) { _done = true; Console.WriteLine (\u0026#34;Done\u0026#34;); } } ä¸¤ä¸ªçº¿ç¨‹å…±äº«äº† _done æ‰€ä»¥ã€ŒDoneã€ä»…ä»…è¾“å‡ºä¸€æ¬¡ã€‚\næ¢æˆ Lambda è¡¨è¾¾å¼ä¹Ÿæ˜¯å¯ä»¥å…±äº«çš„ï¼š\n1 2 3 4 5 6 7 bool done = false; ThreadStart action = () =\u0026gt; { if (!done) { done = true; Console.WriteLine (\u0026#34;Done\u0026#34;); } }; new Thread (action).Start(); action(); è¿™å¼•å‡ºäº†ä¸€ä¸ªå…³é”®æ¦‚å¿µï¼šçº¿ç¨‹å®‰å…¨ï¼\nçº¿ç¨‹é” \u0026amp; çº¿ç¨‹å®‰å…¨ Lock \u0026amp; Thread Safety æ¥çœ‹çœ‹é”ğŸ”’ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 class ThreadSafe { static bool _done; static readonly object _locker = new object(); static void Main() { new Thread (Go).Start(); Go(); } static void Go() { lock (_locker) { if (!_done) { Console.WriteLine (\u0026#34;Done\u0026#34;); _done = true; } } } } å…¶å®è¿™ä¹Ÿä¸å¿…å¤šè¯´ï¼Œå°±æ˜¯é˜»æ­¢ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹æŸä¸€å˜é‡ç½¢äº†ã€‚\nå‘çº¿ç¨‹ä¼ é€’æ•°æ® æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³åœ¨çº¿ç¨‹å¼€å§‹çš„æ—¶å€™ä¼ é€’æ•°æ®ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š\n1 2 3 4 Thread t = new Thread ( () =\u0026gt; Print (\u0026#34;Hello from t!\u0026#34;) ); t.Start(); void Print (string message) =\u0026gt; Console.WriteLine (message); ç”¨ Lambda è¡¨è¾¾å¼ä¹Ÿè¡Œï¼š\n1 2 3 4 5 new Thread (() =\u0026gt; { Console.WriteLine (\u0026#34;çœ‹ï¼æˆ‘è·‘åœ¨å¦ä¸€ä¸ªçº¿ç¨‹é‡Œï¼\u0026#34;); Console.WriteLine (\u0026#34;æœ‰æ‰‹å°±è¡Œï¼\u0026#34;); }).Start(); æ•è·å˜é‡ Captured Variables ä¸€å®šè¦å°å¿ƒæ•è·å˜é‡ï¼š\n1 2 for (int i = 0; i \u0026lt; 10; i++) new Thread (() =\u0026gt; Console.Write (i)).Start(); è¾“å‡ºç»“æœæ˜¯ä¸ç¡®å®šçš„ï¼ç»“æœï¼š\n1 0223557799 é—®é¢˜æ‰€åœ¨æ˜¯å˜é‡ i æŒ‡å‘äº†å¾ªç¯ä¸­åŒä¸€å†…å­˜ä½ç½®ã€‚æ‰€ä»¥å˜é‡ i çš„å€¼å…¶å®ä¸€ç›´åœ¨è¢«ä¸åŒçº¿ç¨‹ä¿®æ”¹ã€‚\nè§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ä¸´æ—¶å˜é‡ï¼š\n1 2 3 4 5 for (int i = 0; i \u0026lt; 10; i++) { int temp = i; new Thread (() =\u0026gt; Console.Write (temp)).Start(); } å†æ¥çœ‹çœ‹ç±»ä¼¼çš„é—®é¢˜ï¼š\n1 2 3 4 5 6 7 string text = \u0026#34;t1\u0026#34;; Thread t1 = new Thread ( () =\u0026gt; Console.WriteLine (text) ); text = \u0026#34;t2\u0026#34;; Thread t2 = new Thread ( () =\u0026gt; Console.WriteLine (text) ); t1.Start(); t2.Start(); å› ä¸ºä¸¤ä¸ª Lambda è¡¨è¾¾å¼æ•è·äº†åŒä¸€å˜é‡ textï¼Œæ‰€ä»¥å€¼ t2 ä¼šè¢«è¾“å‡ºä¸¤æ¬¡ã€‚\nå¼‚å¸¸å¤„ç† å…ˆçœ‹çœ‹ä¸æ­£ç¡®çš„å†™æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 try { new Thread (Go).Start(); } catch (Exception ex) { // æ°¸è¿œä¸ä¼šåˆ°è¾¾è¿™é‡Œï¼ Console.WriteLine (\u0026#34;Exception!\u0026#34;); } void Go() { throw null; } // æœ¬åº”è¯¥æŠ›å‡ºNullå¼•ç”¨é”™è¯¯ æ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„æ‰§è¡Œè·¯å¾„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨çº¿ç¨‹ä¹‹å¤–æ•è·å¼‚å¸¸æ˜¯æ²¡ç”¨çš„ã€‚\nè§£å†³æ–¹æ¡ˆæ˜¯æŠŠå¼‚å¸¸å¤„ç†è¯­å¥æ”¾å…¥æ–¹æ³•å†…ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 new Thread (Go).Start(); void Go() { try { throw null; } catch (Exception ex) { // è¿™æ ·å°±å¯ä»¥æ•è·äº† } } é›†ä¸­å¼‚å¸¸å¤„ç† Centralized Exception Handler åœ¨ WPFã€UWP æˆ–è€… WinForm åº”ç”¨é‡Œï¼Œæˆ‘ä»¬å¯ä»¥è®¢é˜…å…¨å±€å¼‚å¸¸å¤„ç†äº‹ä»¶ Application.DispatcherUnhandledException ä»¥åŠ Application.ThreadExceptionã€‚\nå‰å°çº¿ç¨‹ \u0026amp; åå°çº¿ç¨‹ Foreground \u0026amp; Background Threads é»˜è®¤æƒ…å†µä¸‹ï¼Œä½ æ˜¾å¼åˆ›å»ºçš„çº¿ç¨‹éƒ½æ˜¯å‰å°çº¿ç¨‹ã€‚ç¨‹åºç»“æŸï¼Œä½ çš„æ˜¾å¼çº¿ç¨‹ä¹Ÿä¼šç»“æŸã€‚\nåå°çº¿ç¨‹åˆ™ä¸ç„¶ï¼Œä¾ç„¶ä¼šä¿æŒè¿è¡Œã€‚\nä½ å¯ä»¥ç”¨ IsBackground å±æ€§æ¥æ“ä½œå‰åå°çŠ¶æ€ï¼š\n1 2 3 4 5 6 static void Main (string[] args) { Thread worker = new Thread ( () =\u0026gt; Console.ReadLine() ); if (args.Length \u0026gt; 0) worker.IsBackground = true; worker.Start(); } çº¿ç¨‹çº§åˆ« Thread Priority ä¸€ä¸ªçº¿ç¨‹çš„ Priority å±æ€§å†³å®šäº†å®ƒå¯ä»¥è¿è¡Œå¤šä¹…ï¼ˆç›¸è¾ƒäºå…¶å®ƒçº¿ç¨‹è€Œè¨€ï¼‰ï¼š\n1 enum ThreadPriority { Lowest, BelowNormal, Normal, AboveNormal, Highest } å‘ä¿¡å· Signaling æœ‰æ—¶ï¼Œä½ éœ€è¦çº¿ç¨‹ä¸€ç›´ç­‰å¾…ç›´åˆ°æ”¶åˆ°å…¶å®ƒçº¿ç¨‹å‘é€çš„é€šçŸ¥ï¼Œè¿™å°±æ˜¯ Signalingã€‚\næœ€ç®€å•çš„ Signaling ç»“æ„æ˜¯ ManualResetEvent ã€‚\nåœ¨ä¸€ä¸ª ManualResetEvent å—ä¸­è°ƒç”¨ WaitOne æ–¹æ³•ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°å¦ä¸€çº¿ç¨‹è°ƒç”¨ Set æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 var signal = new ManualResetEvent (false); new Thread (() =\u0026gt; { Console.WriteLine (\u0026#34;Waiting for signal...\u0026#34;); signal.WaitOne(); signal.Dispose(); Console.WriteLine (\u0026#34;Got signal!\u0026#34;); }).Start(); Thread.Sleep(2000); signal.Set(); // å‘é€ä¿¡å· çº¿ç¨‹åœ¨å®¢æˆ·ç«¯åº”ç”¨ Threading in Rich Client Applications åœ¨ WPF æˆ–è€… UWP ç­‰ç­‰å®¢æˆ·ç«¯çš„å¼€å‘ä¸­ï¼Œä½†æˆ‘ä»¬è¦æ‰§è¡Œè€—æ—¶çš„ä»»åŠ¡æ—¶ï¼Œé€šå¸¸çš„åšæ³•æ˜¯å¯åŠ¨ä¸€ä¸ªã€ŒWorkerã€çº¿ç¨‹ã€‚\nå½“ä½ æƒ³è¦ä»ã€ŒWorkerã€çº¿ç¨‹æ›´æ–° UI æ—¶ï¼Œä½ å¿…é¡»ä¼ é€’è‡³ UI çº¿ç¨‹ã€‚ç¼–ç¨‹æœ¯è¯­ã€Œç¼–åˆ— Marshalã€ä¸“é—¨æŒ‡ä»£è¿™ä¸€è¡Œä¸ºã€‚\nWPFï¼šè°ƒç”¨ Dispatcher å¯¹è±¡çš„ BeginInvoke æˆ– Invoke æ–¹æ³•\nUWPï¼šè°ƒç”¨ Dispatcher å¯¹è±¡çš„ RunAsync æˆ– Invoke æ–¹æ³•\nWinFormï¼šè°ƒç”¨æ§ä»¶çš„ BeginInvoke æˆ– Invoke æ–¹æ³•\nè¿™äº›æ–¹æ³•çš„å®è´¨éƒ½æ˜¯æŠŠä½ æƒ³è¦æ‰§è¡Œçš„æ–¹æ³•æ¨é€åˆ° UI çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚\nä½†æ˜¯ Invoke æ–¹æ³•æœ‰ä¸€ç‚¹ç‰¹æ®Šï¼šå®ƒä¼šé˜»å¡çº¿ç¨‹ç›´åˆ°æ¶ˆæ¯è¢« UI çº¿ç¨‹å¤„ç†ã€‚å› æ­¤å®ƒå¯ä»¥ç”¨æ¥è¿”å›å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 partial class MyWindow : Window { public MyWindow() { InitializeComponent(); new Thread (Work).Start(); } void Work() { Thread.Sleep (5000); // å‡è£…è€—æ—¶ä»»åŠ¡ UpdateMessage (\u0026#34;The answer\u0026#34;); } void UpdateMessage (string message) { Action action = () =\u0026gt; txtMessage.Text = message; Dispatcher.BeginInvoke (action); } } åŒæ­¥ä¸Šä¸‹æ–‡ Synchronization Contexts WPFã€UWP ç­‰ç­‰æ¡†æ¶éƒ½å®ç°äº†è¿™ä¸ªç±»ï¼ˆå­ç±»ï¼‰ã€‚\nè¿™ä¸ªç±»è¢«æ”¾åœ¨ System.ComponentModel ä¸­ï¼Œç”¨æ¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œ ã€ŒMarshalã€æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 partial class MyWindow : Window { SynchronizationContext _uiSyncContext; public MyWindow() { InitializeComponent(); // è·å–å½“å‰UIçº¿ç¨‹çš„åŒæ­¥ä¸Šä¸‹æ–‡ _uiSyncContext = SynchronizationContext.Current; new Thread (Work).Start(); } void Work() { Thread.Sleep (5000); // å‡è£…è€—æ—¶æ“ä½œ UpdateMessage (\u0026#34;The answer\u0026#34;); } void UpdateMessage (string message) { // Marshalå§”æ‰˜è‡³UIçº¿ç¨‹ _uiSyncContext.Post (_ =\u0026gt; txtMessage.Text = message, null); } } è°ƒç”¨ Post æ–¹æ³•ç­‰ä»·äºè°ƒç”¨ BeginInvoke æ–¹æ³•ã€‚\nçº¿ç¨‹æ±  The Thread Pool çº¿ç¨‹æ± å°±æ˜¯ç”¨æ¥æ–¹ä¾¿å¤šçº¿ç¨‹ç®¡ç†çš„ã€‚\næœ‰å‡ ç‚¹å€¼å¾—æ³¨æ„ï¼š\nä½ ä¸èƒ½ä¸ºæ± çº¿ç¨‹è®¾ç½® Name å±æ€§ï¼Œè¿™ä¼šè®© Debug æ›´åŠ å›°éš¾\næ± çº¿ç¨‹é€šå¸¸æ˜¯åå°çº¿ç¨‹\né˜»å¡æ± çº¿ç¨‹ä¼šå¯¼è‡´æ€§èƒ½é™ä½\nä½ å¯ä»¥æ”¹å˜æ± çº¿ç¨‹çš„çº§åˆ«ã€‚\nä½ å¯ä»¥é€šè¿‡ Thread.CurrentThread.IsThreadPoolThread. æ¥æŒ‡å®šæ˜¯å¦è®©çº¿ç¨‹åœ¨æ± é‡Œè¿è¡Œã€‚\nè¿›å…¥çº¿ç¨‹æ±  Enter the pool æœ€ç®€å•çš„æ–¹å¼æ˜¯ï¼š\n1 Task.Run (() =\u0026gt; Console.WriteLine (\u0026#34;ä½ å…ˆåˆ«æ€¥ï¼ŒTaskåé¢ä¼šè®²\u0026#34;)); åœ¨ .NET Framework 4.0 ä»¥å‰çš„ä¸Šå¤æ—¶æœŸ C# æ²¡æœ‰ Task åç¨‹ï¼Œæ˜¯è¿™æ ·è¿›å…¥çº¿ç¨‹æ± çš„ï¼š\n1 ThreadPool.QueueUserWorkItem (notUsed =\u0026gt; Console.WriteLine (\u0026#34;Hello\u0026#34;)); éšå¼ä½¿ç”¨çº¿ç¨‹æ± çš„åº“ï¼š\nASP.NET Core / Web API åº”ç”¨\nSystem.Timers.Timer å’Œ System.Threading.Timer\nBackgroundWorker ç±»ï¼ˆä¼ ç»Ÿï¼‰\nçº¿ç¨‹æ± å«ç”Ÿ Hygiene in the thread pool çº¿ç¨‹æ± è¿˜æœ‰ä¸€ä¸ªä½œç”¨æ˜¯ä¿è¯ CPU ä¸ä¼šã€Œè¶…é¢è®¤è´­ Oversubscriptionã€ã€‚\nã€ŒOversubscriptionã€æŒ‡çš„æ˜¯æ´»è·ƒçº¿ç¨‹æ•°é‡è¶…è¿‡ CPU æ ¸å¿ƒæ•°é‡çš„çŠ¶æ€ã€‚\næ€»ä¹‹ï¼ŒCLR ä¼šé€šè¿‡æ’åºä»»åŠ¡é˜Ÿåˆ—å’Œå‡é€Ÿä»»åŠ¡å¯åŠ¨æ¥é˜»æ­¢ã€Œè¶…é¢è®¤è´­ã€ã€‚\nä»»åŠ¡ Task åˆ›å»ºä»»åŠ¡ Create a Task 1 2 Task.Run (() =\u0026gt; Console.WriteLine (\u0026#34;Foo\u0026#34;)); Console.ReadLine(); //ç”¨æ¥é˜»å¡ä¸€ä¸‹ ç­‰å¾… Wait å’Œçº¿ç¨‹çš„ Join ç±»ä¼¼ï¼š\n1 2 3 4 5 6 7 8 Task task = Task.Run (() =\u0026gt; { Thread.Sleep (2000); Console.WriteLine (\u0026#34;Foo\u0026#34;); }); Console.WriteLine (task.IsCompleted); // False task.Wait(); // é˜»å¡ç›´åˆ°Taskç»“æŸ è€—æ—¶ä»»åŠ¡ LongRunning Task CLR é»˜è®¤ä¼šè®© Task è¿è¡Œåœ¨æ± çº¿ç¨‹ï¼ˆé€‚ç”¨äºçŸ­æ—¶è®¡ç®—çš„çº¿ç¨‹ï¼‰ã€‚\nä¸ºäº†è¿è¡Œè€—æ—¶é•¿çš„ Taskï¼š\n1 Task task = Task.Factory.StartNew (() =\u0026gt; ..., TaskCreationOptions.LongRunning); è¿”å›å€¼ Return Values æœ€ç®€å•çš„è¿”å›å€¼å†™æ³•ï¼š\n1 Task\u0026lt;int\u0026gt; task = Task.Run (() =\u0026gt; { Console.WriteLine (\u0026#34;Foo\u0026#34;); return 3; }); ä½ å¯ä»¥é€šè¿‡ Task çš„ Result å±æ€§æ¥è·å–è¿”å›å€¼ã€‚è¿™æ­¥æ“ä½œå°†ä¼šé˜»å¡çº¿ç¨‹ç›´è‡³ Task ç»“æŸï¼š\n1 2 int result = task.Result; Console.WriteLine(result); æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ LINQ çš„ Taskï¼Œç”¨ä»¥è®¡ç®— 300 0000 ä»¥å†…çš„ç´ æ•°ï¼š\n1 2 3 4 5 6 Task\u0026lt;int\u0026gt; primeNumberTask = Task.Run (() =\u0026gt; Enumerable.Range (2, 3000000).Count (n =\u0026gt; Enumerable.Range (2, (int)Math.Sqrt(n)-1).All (i =\u0026gt; n % i \u0026gt; 0))); Console.WriteLine (\u0026#34;Task running...\u0026#34;); Console.WriteLine (\u0026#34;The answer is \u0026#34; + primeNumberTask.Result); å¼‚å¸¸ Exception 1 2 3 4 5 6 7 8 9 10 11 12 13 //å¼€å¯ä¸€ä¸ªæŠ›å‡ºNullReferenceExceptionçš„Task Task task = Task.Run (() =\u0026gt; { throw null; }); try { task.Wait(); } catch (AggregateException aex) { if (aex.InnerException is NullReferenceException) Console.WriteLine (\u0026#34;Null!\u0026#34;); else throw; } åç»­ Continuations é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å½“ Task ç»“æŸä¹‹åè¯¥å¹²å•¥ï¼š\n1 2 3 4 5 6 7 8 9 10 Task\u0026lt;int\u0026gt; primeNumberTask = Task.Run (() =\u0026gt; Enumerable.Range (2, 3000000).Count (n =\u0026gt; Enumerable.Range (2, (int)Math.Sqrt(n)-1).All (i =\u0026gt; n % i \u0026gt; 0))); var awaiter = primeNumberTask.GetAwaiter(); awaiter.OnCompleted (() =\u0026gt; { int result = awaiter.GetResult(); Console.WriteLine (result); }); C# å¼‚æ­¥ç¼–ç¨‹ ç»ˆäºåˆ°äº†æœ¬ç« çš„é‡å¤´æˆäº†ï¼\nAwaiting await å…³é”®å­—è‡ªåŠ¨é™„åŠ åç»­æ“ä½œã€‚\nç®€å•ä½¿ç”¨ï¼š\n1 2 var result = await expression; statement(s); ç¼–è¯‘å™¨ä¼šæŠŠè¿™å°æ®µä»£ç è‡ªåŠ¨è½¬åŒ–ä¸ºï¼š\n1 2 3 4 5 6 var awaiter = expression.GetAwaiter(); awaiter.OnCompleted (() =\u0026gt; { var result = awaiter.GetResult(); statement(s); }); æ¥çœ‹çœ‹ä¹‹å‰çš„ä»£ç ï¼š\n1 2 3 4 5 6 Task\u0026lt;int\u0026gt; GetPrimesCountAsync (int start, int count) { return Task.Run (() =\u0026gt; ParallelEnumerable.Range (start, count).Count (n =\u0026gt; Enumerable.Range (2, (int)Math.Sqrt(n)-1).All (i =\u0026gt; n % i \u0026gt; 0))); } ä½¿ç”¨ await å…³é”®å­—ï¼Œæˆ‘ä»¬å¯ä»¥å¦‚ä¸‹è°ƒç”¨ï¼š\n1 2 int result = await GetPrimesCountAsync (2, 1000000); Console.WriteLine (result); ä½†åœ¨ç¼–è¯‘å‰ï¼Œæˆ‘ä»¬éœ€è¦ç»™å¤–å±‚ä»£ç åŠ ä¸€ä¸ª async å…³é”®å­—ï¼š\n1 2 3 4 5 async void DisplayPrimesCount() { int result = await GetPrimesCountAsync (2, 1000000); Console.WriteLine (result); } async å…³é”®å­—åªèƒ½åŠ ç»™è¿”å›å€¼ç±»å‹æ˜¯ voidï¼ŒTask ä»¥åŠ Task\u0026lt;TResult\u0026gt; çš„æ–¹æ³•ã€‚\nå½“è¿”å›å€¼æ˜¯ç©ºæ—¶ï¼š\n1 2 await Task.Delay (5000); Console.WriteLine (\u0026#34;Five seconds passed!\u0026#34;); æ•è·å±€éƒ¨å˜é‡ Capturing local state await çš„çœŸæ­£åŠ›é‡åœ¨äºå®ƒå¯ä»¥å‡ºç°åœ¨ä»£ç çš„ä»»æ„ä½ç½®ï¼ˆä½†ä¸èƒ½åœ¨çº¿ç¨‹é”ä»¥åŠ unsafe å—ä¸­ï¼‰ï¼š\n1 2 3 4 5 async void DisplayPrimeCounts() { for (int i = 0; i \u0026lt; 10; i++) Console.WriteLine (await GetPrimesCountAsync (i*1000000+2, 1000000)); } åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ GetPrimesCountAsync ä¹‹åï¼Œå˜é‡ i çš„å€¼ä¼šè¢«ä¿å­˜ã€‚\nåœ¨ UI ä¸­ç­‰å¾… Awaiting in a UI æˆ‘ä»¬å…ˆä»ä¸€ä¸ªåŒæ­¥çš„ä»£ç å¼€å§‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 class TestUI : Window { Button _button = new Button { Content = \u0026#34;Go\u0026#34; }; TextBlock _results = new TextBlock(); public TestUI() { var panel = new StackPanel(); panel.Children.Add (_button); panel.Children.Add (_results); Content = panel; _button.Click += (sender, args) =\u0026gt; Go(); } void Go() { for (int i = 1; i \u0026lt; 5; i++) _results.Text += GetPrimesCount (i * 1000000, 1000000) + \u0026#34; primes between \u0026#34; + (i*1000000) + \u0026#34; and \u0026#34; + ((i+1)*1000000-1) + Environment.NewLine; } int GetPrimesCount (int start, int count) { return ParallelEnumerable.Range (start, count).Count (n =\u0026gt; Enumerable.Range (2, (int) Math.Sqrt(n)-1).All (i =\u0026gt; n % i \u0026gt; 0)); } } å¯ä»¥çœ‹åˆ°ç‚¹å‡»æŒ‰é’®å°±ä¼šé˜»å¡çº¿ç¨‹ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨å¼‚æ­¥æ”¹å†™ã€‚\nç¬¬ä¸€æ­¥æ˜¯æŠŠè®¡ç®—ç´ æ•°çš„æ–¹æ³•æ”¹æˆå¼‚æ­¥çš„ï¼š\n1 2 3 4 Task\u0026lt;int\u0026gt; GetPrimesCountAsync (int start, int count) { return Task.Run (() =\u0026gt; ParallelEnumerable.Range (start, count).Count(n =\u0026gt; Enumerable.Range(2, (int) Math.Sqrt(n)-1).All (i =\u0026gt; n % i \u0026gt; 0))); } ç¬¬äºŒæ­¥æ˜¯ä¿®æ”¹ Go æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 async void Go() { _button.IsEnabled = false; for (int i = 1; i \u0026lt; 5; i++) _results.Text += await GetPrimesCountAsync (i * 1000000, 1000000) + \u0026#34; primes between \u0026#34; + (i*1000000) + \u0026#34; and \u0026#34; + ((i+1)*1000000-1) + Environment.NewLine; _button.IsEnabled = true; } å†æ¥å¦ä¸€ä¸ªä¾‹å­ï¼Œè¿™å›æˆ‘ä»¬æƒ³è¦ä»ç½‘ç»œä¸Šå¼‚æ­¥åœ°ä¸‹è½½æ•°æ®äº†ã€‚\né‡å†™ Go æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 async void Go() { _button.IsEnabled = false; string[] urls = \u0026#34;yoroion.github.io www.oreilly.com sinoahpx.github.io\u0026#34;.Split(); int totalLength = 0; try { foreach (string url in urls) { var uri = new Uri(\u0026#34;http://\u0026#34; + url) byte[] data = await new WebClient().DownloadDataTaskAsync (uri); _results.Text += \u0026#34;Length of \u0026#34; + url + \u0026#34; is \u0026#34; + data.Length + Environment.NewLine; totalLength += data.Length; } _results.Text += \u0026#34;Total length: \u0026#34; + totalLength; } catch { _results.Text += \u0026#34;Error: \u0026#34; + ex.Message; } finally { _button.IsEnabled = true; } } æˆ‘ä»¬é™„åŠ åœ¨ UI æ§ä»¶ä¸Šçš„ Event Handler åœ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆmessage loopï¼‰ä¸­è¿›è¡Œã€‚\nå½“æˆ‘ä»¬çš„ Go æ–¹æ³•è¿è¡Œæ—¶ï¼Œç›´è‡³é‡åˆ° await è¡¨è¾¾å¼ï¼Œä¼šè·³è½¬å›æ¶ˆæ¯é˜Ÿåˆ—æ¥æ¥å“åº”å…¶å®ƒäº‹ä»¶ã€‚\nç¼–å†™å¼‚æ­¥æ–¹æ³• Writing Asynchronous Functions ç¼–å†™å¼‚æ­¥æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç©ºè¿”å›å€¼çš„æ–¹æ³•æ”¹æˆè¿”å› Taskï¼š\n1 2 3 4 5 6 async Task PrintAnswerToLife() //Task æ›¿ä»£äº† void { await Task.Delay (5000); int answer = 21 * 2; Console.WriteLine (answer); } å¯ä»¥å‘ç°æˆ‘ä»¬å¹¶æ²¡æœ‰æ˜¾å¼åœ°è¿”å› Taskï¼Œç¼–è¯‘å™¨å¸®æˆ‘ä»¬ç®€åŒ–äº†ï¼š\n1 2 3 4 5 async Task Go() { await PrintAnswerToLife(); Console.WriteLine(\u0026#34;Done\u0026#34;); } è¿”å› Task 1 2 3 4 5 6 async Task\u0026lt;int\u0026gt; GetAnswerToLife() { await Task.Delay (5000); int answer = 21 * 2; return answer; //ç›´æ¥è¿”å›æ•´å‹ } æ•´ä½“çœ‹ä¸€ä¸‹ä»£ç :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 async Task Go() { await PrintAnswerToLife(); Console.WriteLine (\u0026#34;Done\u0026#34;); } async Task PrintAnswerToLife() { int answer = await GetAnswerToLife(); Console.WriteLine (answer); } async Task\u0026lt;int\u0026gt; GetAnswerToLife() { await Task.Delay (5000); int answer = 21 * 2; return answer; } è¿™ä¹Ÿæ­ç¤ºäº† C# ä¸­ç¼–å†™å¼‚æ­¥æ–¹æ³•çš„åŸºæœ¬åŸåˆ™:\nå…ˆåŒæ­¥åœ°ç¼–å†™ä»£ç  å°†åŒæ­¥æ–¹æ³•æ”¹æˆå¼‚æ­¥çš„ è¿”å›å€¼æ”¹æˆ Task æˆ– Task å¹¶è¡Œ Parallelism ","date":"2022-08-15T00:00:00Z","image":"https://kyocius.github.io/p/advanced-csharp-1/head_hu6445997bcd53608f7e2f035aad872a86_31881_120x120_fill_box_smart1_3.png","permalink":"https://kyocius.github.io/p/advanced-csharp-1/","title":"é§æ©çš„ C# è¿›é˜¶å°å†Œ  01 - å¹¶å‘ä¸å¼‚æ­¥"},{"content":"å‰è¨€ ä¹‹å‰æˆ‘ä»¬è§è¯†äº† Rx.NET çš„åŸºæœ¬ç”¨æ³•ï¼ŒæŠŠ .NET äº‹ä»¶è½¬åŒ–æˆäº†å¯è§‚å¯Ÿæ•°æ®æµï¼Œå¹¶ä¸”è¡¥å……äº†ä¸€äº›æ‹“å±•çŸ¥è¯†ï¼ˆExï¼‰ï¼Œç°åœ¨æˆ‘ä»¬è¦æ¥ç€æ·±å…¥ Rx.NET çš„æ ¸å¿ƒæŠ€æœ¯äº†ã€‚\næ™®é€šæ•°æ®æµ è¿˜è®°å¾—å—ï¼ŒIObservable æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³• Subscribeï¼Œæ˜¯ Rx.NET çš„åŸºç¡€ã€‚\næˆ‘ä»¬å°†è¯•ç€æ‰“é€ ä¸€ä¸ªå³æ—¶é€šè®¯ç³»ç»Ÿã€‚\nå®ç° IObservable æ¥å£ åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œéå¸¸ä¸æ¨èç›´æ¥å®ç° IObservable æ¥å£ï¼Œä½†æ˜¯ç†è§£è¿™ä¸ªæµç¨‹å¯¹æˆ‘ä»¬çš„å­¦ä¹ å¾ˆæœ‰å¸®åŠ©ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 using System; using System.Reactive.Disposables; public class NumbersObservable : IObservable\u0026lt;int\u0026gt; { private readonly int _amount; public NumbersObservable(int amount) { _amount = amount; } public IDisposable Subscribe(IObserver\u0026lt;int\u0026gt; observer) { for (int i = 0; i \u0026lt; _amount; i++) { observer.OnNext(i); } observer.OnCompleted(); return Disposable.Empty; } } å®ç° Observer æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public class ConsoleObserver\u0026lt;T\u0026gt; : IObserver\u0026lt;T\u0026gt; { private readonly string _name; public ConsoleObserver(string name=\u0026#34;\u0026#34;) { _name = name; } public void OnNext(T value) { Console.WriteLine(\u0026#34;{0} - OnNext({1})\u0026#34;,_name,value); } public void OnError(Exception error) { Console.WriteLine(\u0026#34;{0} - OnError:\u0026#34;, _name); Console.WriteLine(\u0026#34;\\t {0}\u0026#34;, error); } public void OnCompleted() { Console.WriteLine(\u0026#34;{0} - OnCompleted()\u0026#34;, _name); } } æœ€åæ¶ˆè´¹å®ƒï¼š\n1 2 3 var numbers = new NumbersObservable(5); var subscription = numbers.Subscribe(new ConsoleObserver\u0026lt;int\u0026gt;(\u0026#34;numbers\u0026#34;)); çœ‹çœ‹ç»“æœï¼š\n1 2 3 4 5 6 numbers - OnNext(0) numbers - OnNext(1) numbers - OnNext(2) numbers - OnNext(3) numbers - OnNext(4) numbers - OnCompleted() æˆ‘ä»¬ç°åœ¨æ‰‹åŠ¨å®ç°äº†ä¸€ä¸ªå¯è§‚å¯Ÿæ•°æ®æµå’Œè§‚å¯Ÿè€…ã€‚\nå†æ¥ä¸ªæ‰©å±•æ–¹æ³•æ–¹ä¾¿æˆ‘ä»¬æ‰“å°ï¼Œ\næ³¨æ„ï¼è¿™ä¸ªæ–¹æ³•å°†ä¼šè´¯ç©¿ä¹‹åçš„ç« èŠ‚ï¼š\n1 2 3 4 5 6 7 public static class Extensions { public static IDisposable SubscribeConsole\u0026lt;T\u0026gt;( this IObservable\u0026lt;T\u0026gt; observable, string name = \u0026#34;\u0026#34;) { return observable.Subscribe(new ConsoleObserver\u0026lt;T\u0026gt;(name)); } } æ‰‹åŠ¨åˆ›å»º Observable çš„ç¼ºé™· æ‰‹åŠ¨åˆ›å»ºå¯è§‚å¯Ÿæ•°æ®æµä¸€èˆ¬ä¸æ¨èä¸”å¾ˆå°‘ç”¨ï¼Œå› ä¸ºå¦‚æ­¤æ˜æ˜¾ç¹çä¸”å®¹æ˜“å‡ºé”™ã€‚\né™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœä½ ä¸å°å¿ƒåœ¨ OnComplete æ–¹æ³•ä¹‹åè°ƒç”¨äº† OnNextï¼š\n1 2 3 4 5 6 7 8 9 10 11 public IDisposable Subscribe(IObserver\u0026lt;int\u0026gt; observer) { for (int i = 0; i \u0026lt; _amount; i++) { observer.OnNext(i); } observer.OnCompleted(); observer.OnNext(_amount); // æ³¨æ„è¿™è¡Œ return Disposable.Empty; } ä½ å°†å¾—åˆ°ä»¥ä¸‹ç»“æœï¼š\n1 2 3 4 5 6 7 errorTest - OnNext(0) errorTest - OnNext(1) errorTest - OnNext(2) errorTest - OnNext(3) errorTest - OnNext(4) errorTest - OnComplete errorTest - OnNext(5) æ€ä¹ˆä¼šäº‹æï¼Œ OnComplete ä¹‹åå±…ç„¶è¿˜èƒ½è®¢é˜…åˆ°æ•°æ®ï¼Ÿ\nè¿™æ˜¯ Rx èƒŒå Observable ä¸ Observer çš„ Repeat æ–¹æ³•é‡æ–°è®¢é˜…å¯¼è‡´çš„ã€‚\nObservableBase æ¥å£ æ‰‹å†™ä¹Ÿä¸æ˜¯ä¸å¯ä»¥ï¼Œæ¯”å¦‚å½“ä½ æƒ³å°è£…ä¸€ä¸ªå¤æ‚çš„ã€åŒ…å«äº‹ä»¶å±æ€§çš„æ¥å£çš„æ—¶å€™ï¼š\n1 2 3 4 5 6 7 public interface IChatConnection { event Action\u0026lt;string\u0026gt; Received; event Action Closed; event Action\u0026lt;Exception\u0026gt; Error; void Disconnect(); } æˆ‘ä»¬ä¸€èˆ¬ä¼šå†™ä¸ª Clientï¼š\n1 2 3 4 5 6 7 8 public class ChatClient { ... public IChatConnection Connect(string user, string password) { // è¿æ¥æœåŠ¡ } } å†æ‰‹åŠ¨æ”¹å†™æˆä¸€ä¸ª Observableï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 using System; using System.Reactive; using System.Reactive.Disposables; public class ObservableConnection : ObservableBase\u0026lt;string\u0026gt; { private readonly IChatConnection _chatConnection; public ObservableConnection(IChatConnection chatConnection) { _chatConnection = chatConnection; } protected override IDisposable SubscribeCore(IObserver\u0026lt;string\u0026gt; observer) { Action\u0026lt;string\u0026gt; received = message =\u0026gt; { observer.OnNext(message); }; Action closed = () =\u0026gt; { observer.OnCompleted(); }; Action\u0026lt;Exception\u0026gt; error = ex =\u0026gt; { observer.OnError(ex); }; _chatConnection.Received += received; _chatConnection.Closed += closed; _chatConnection.Error += error; return Disposable.Create(() =\u0026gt; { _chatConnection.Received -= received; _chatConnection.Closed -= closed; _chatConnection.Error -= error; _chatConnection.Disconnect(); }); } } å‘ç°æ²¡ï¼Œè¿™å…¶å®å°±æ˜¯ SignalR çš„å†™æ³•ï¼ˆå¾®è½¯çš„åç«¯æ¡†æ¶ï¼‰\nç°åœ¨æ¶ˆè´¹ï¼š\n1 2 3 4 5 6 var chatClient = new ChatClient(); var connection = chatClient.Connect(\u0026#34;guest\u0026#34;, \u0026#34;guest\u0026#34;); IObservable\u0026lt;string\u0026gt; observableConnection = new ObservableConnection(connection); // æœ€å¼€å§‹çš„é‚£ä¸ªç±» var subscription = observableConnection.SubscribeConsole(\u0026#34;receiver\u0026#34;); å†™ä¸ªæ‰©å±•æ–¹æ³•æ¥ç®€åŒ–æ“ä½œï¼š\n1 2 3 4 5 6 7 public static class ChatExtensions { public static IObservable\u0026lt;string\u0026gt; ToObservable(this IChatConnection connection) { return new ObservableConnection(connection); } } ç»¼åˆä¸‹æ¥çœ‹ï¼Œè¿™ä¹ˆæ‰‹åŠ¨å†™ä¹Ÿå¤ªè¸é©¬æŠ˜ç£¨äº†ã€‚Rx æœ‰æ²¡æœ‰æ–¹æ³•æ¥ç®€åŒ–è¿™äº›æ“ä½œå‘¢ï¼Ÿ\nObservable.Create æ–¹æ³• åˆ«å‚»ä¹ä¹åœ°æ‰‹å†™äº†ï¼ŒRx å¯æ˜¯æä¾›äº†å¥½ç”¨çš„å·¥å‚å‡½æ•°å‘¢ã€‚\n1 2 3 4 5 6 7 8 9 Observable.Create\u0026lt;int\u0026gt;(observer =\u0026gt; { for (int i = 0; i \u0026lt; 5; i++) { observer.OnNext(i); } observer.OnCompleted(); return Disposable.Empty; }); ç›´æ¥å†™ä¸ª Lambda è¡¨è¾¾å¼æ¥ä½œä¸º Subscribe æ–¹æ³•ã€‚\nObservable.Create éå¸¸çµæ´»ï¼Œå› æ­¤ä¹Ÿè¢«å¤§é‡ä½¿ç”¨åœ¨ Rx çš„åº”ç”¨ä¸­ã€‚\nå»¶è¿Ÿåˆå§‹åŒ– Defer 1 2 3 4 5 public IObservable\u0026lt;string\u0026gt; ObserveMessages(string user, string password) { var connection = Connect(user, password); return connection.ToObservable(); } å½“æˆ‘ä»¬æƒ³è¦è¿™ä¸ªå¯è§‚å¯Ÿæ•°æ®æµä»…åœ¨æœ‰è§‚å¯Ÿè€…è®¢é˜…å®ƒçš„æ—¶å€™æ‰ä¼šè¢«åˆ›å»ºæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Observable.Defer æ–¹æ³•æ¥å»¶è¿Ÿåˆå§‹åŒ–ï¼š\n1 2 3 4 5 6 7 8 public IObservable\u0026lt;string\u0026gt; ObserveMessagesDeferred(string user, string password) { return Observable.Defer(() =\u0026gt; { var connection = Connect(user, password); return connection.ToObservable(); }); } éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œç”±è¿™äº›å·¥å‚å‡½æ•°åˆ›å»ºçš„å¯è§‚å¯Ÿæ•°æ®æµå¹¶ä¸èƒ½å…±äº«è§‚å¯Ÿè€…ï¼š\n1 2 3 var messages = chatClient.ObserveMessagesDeferred(\u0026#34;user\u0026#34;,\u0026#34;password\u0026#34;); var subscription1 = messages.SubscribeConsole(); var subscription2 = messages.SubscribeConsole(); ä¹Ÿå°±æ˜¯è¯´ï¼Œ subscription1 å’Œ subscription2 æ˜¯ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„å®ä¾‹ã€‚\nå…³äºã€Œå…±äº«æµã€ã€Œçƒ­æµã€ä»¥åŠã€Œå†·æµã€çš„çŸ¥è¯†å°†ä¼šåœ¨ç¬¬å…­ç« è®²è§£ã€‚\nç”±äº‹ä»¶è½¬æ¢ åœ¨ç¬¬äºŒç« æˆ‘ä»¬å·²ç»è§è¯†è¿‡äº†ï¼Œè¿™å›æ¥ç‚¹å„¿æ›´æ·±å…¥çš„ã€‚\nå…ˆçœ‹å®šä¹‰ï¼š\n1 FromEventPattern\u0026lt;TDelegate, TEventArgs\u0026gt;(Action\u0026lt;TDelegate\u0026gt; addHandler, Action\u0026lt;TDelegate\u0026gt; removeHandler) æ ‡å‡†äº‹ä»¶ æ¥ä¸ªäº‹ä»¶ï¼š\n1 public event RoutedEventHandler Click; è¿™ä¸ªå§”æ‰˜ç±»å‹æ˜¯ System.Windows ä¸­å®šä¹‰å¥½çš„ï¼š\n1 public delegate void RoutedEventHandler(object sender, System.Windows.RoutedEventArgs e) è½¬åŒ–æˆå¯è§‚å¯Ÿçš„äº‹ä»¶æµï¼š\n1 2 3 4 5 IObservable\u0026lt;EventPattern\u0026lt;RoutedEventArgs\u0026gt;\u0026gt; clicks = Observable.FromEventPattern\u0026lt;RoutedEventHandler, RoutedEventArgs\u0026gt;( h =\u0026gt; theButton.Click += h, h =\u0026gt; theButton.Click -= h); clicks.SubscribeConsole(); Rx è¿˜æä¾›äº†ä¸€ç§ç®€åŒ–çš„å†™æ³•ï¼Œä½†å¹¶ä¸æ¨èï¼š\n1 2 IObservable\u0026lt;EventPattern\u0026lt;object\u0026gt;\u0026gt; clicks = Observable.FromEventPattern(theButton, \u0026#34;Click\u0026#34;); ä¸æ ‡å‡†äº‹ä»¶ å¹¶ä¸æ˜¯æ‰€æœ‰äº‹ä»¶çš„å‚æ•°éƒ½æ˜¯ä¸€ä¸ª Sender + ä¸€ä¸ª EventArgsã€‚\n1 2 3 4 5 6 7 public delegate void NetworkFoundEventHandler(string ssid); class WifiScanner { public event NetworkFoundEventHandler NetworkFound = delegate { }; // ... } å¯ä»¥çœ‹åˆ°è¿™ä¸ªäº‹ä»¶éœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ã€‚\nä¹‹å‰çš„ FromEventPattern å°±ä¸èƒ½ç”¨äº†ï¼ŒRx æä¾›äº† FromEventï¼š\n1 IObservable\u0026lt;TEventArgs\u0026gt; FromEvent\u0026lt;TDelegate, TEventArgs\u0026gt;(Action\u0026lt;TDelegate\u0026gt; addHandler, Action\u0026lt;TDelegate\u0026gt; removeHandler); å¦‚æ­¤å°±å¯ä»¥ï¼š\n1 2 3 4 5 var wifiScanner = new WifiScanner(); IObservable\u0026lt;string\u0026gt; networks = Observable.FromEvent\u0026lt;NetworkFoundEventHandler, string\u0026gt;( h =\u0026gt; wifiScanner.NetworkFound += h, h =\u0026gt; wifiScanner.NetworkFound -= h); æ›´å¤æ‚çš„äº‹ä»¶ Of courseï¼Œè¿˜æœ‰æ›´å¤æ‚çš„äº‹ä»¶ï¼š\n1 2 3 4 5 6 public delegate void ExtendedNetworkFoundEventHandler(string ssid, int strength); class WifiScanner { public event ExtendedNetworkFoundEventHandler ExtendedNetworkFound = delegate { }; } æ”¾å¿ƒï¼ŒFromEvent æä¾›äº†é‡è½½ï¼š\n1 2 3 4 IObservable\u0026lt;TEventArgs\u0026gt; FromEvent\u0026lt;TDelegate, TEventArgs\u0026gt;( Func\u0026lt;Action\u0026lt;TEventArgs\u0026gt;, TDelegate\u0026gt; conversion, Action\u0026lt;TDelegate\u0026gt; addHandler, Action\u0026lt;TDelegate\u0026gt; removeHandler); ä¸‹é¢éœ€è¦åˆ©ç”¨å…ƒç»„ï¼ˆTupleï¼‰çš„ç‰¹æ€§ï¼š\n1 2 3 4 5 IObservable\u0026lt;Tuple\u0026lt;string, int\u0026gt;\u0026gt; networks = Observable.FromEvent\u0026lt;ExtendedNetworkFoundEventHandler, Tuple\u0026lt;string, int\u0026gt;\u0026gt;( rxHandler =\u0026gt; (ssid, strength) =\u0026gt; rxHandler(Tuple.Create(ssid, strength)), h =\u0026gt; wifiScanner.ExtendedNetworkFound += h, h =\u0026gt; wifiScanner.ExtendedNetworkFound -= h); æ— å‚äº‹ä»¶ 1 event Action Connected = delegate { }; æˆ‘ä»¬éœ€è¦è¿™ä¹ˆå†™ï¼š\n1 2 3 4 5 IObservable\u0026lt;Unit\u0026gt; connected = Observable.FromEvent(h =\u0026gt; wifiScanner.Connected += h, h =\u0026gt; wifiScanner.Connected -= h); connected.SubscribeConsole(\u0026#34;connected\u0026#34;); Unit ç±»å‹ä»£è¡¨äº†ã€Œç©ºã€ï¼Œå®ƒ ToString ä¹‹åçš„å€¼ä¸ºã€Œ()ã€\næ‰€ä»¥ä½ ä¼šå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š\n1 2 connected - OnNext(()) connected - OnNext(()) ç”±è¿­ä»£ç±»å‹è½¬æ¢ è¿­ä»£ç±»å‹å’Œå¯è§‚å¯Ÿç±»å‹é•¿å¾—å¾ˆåƒï¼ŒRx ä¹Ÿæä¾›äº†è½¬æ¢çš„æ–¹æ³•ã€‚\nè¿­ä»£ç±»å‹ â†’ å¯è§‚å¯Ÿæµ 1 2 3 4 IEnumerable\u0026lt;string\u0026gt; names = new []{\u0026#34;AHpx\u0026#34;, \u0026#34;Yoroion\u0026#34;, \u0026#34;Weeknic\u0026#34;, \u0026#34;GodLeaveMe\u0026#34;}; IObservable\u0026lt;string\u0026gt; observable = names.ToObservable(); observable.SubscribeConsole(\u0026#34;names\u0026#34;); ä½ å°†ä¼šå¾—åˆ°ï¼š\n1 2 3 4 5 names - OnNext(AHpx) names - OnNext(Yoroion) names - OnNext(Weekenic) names - OnNext(GodLeaveMe) names - OnCompleted() å¦‚æœè¿­ä»£çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œé‚£ä¹ˆæŠ¥é”™å°±ä¼šä¼ é€’è‡³ OnError æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 class Program { static void Main(string[] args) { NumbersAndThrow() .ToObservable() .SubscribeConsole(\u0026#34;names\u0026#34;); Console.ReadLine(); } static IEnumerable\u0026lt;int\u0026gt; NumbersAndThrow() { yield return 1; yield return 2; yield return 3; throw new ApplicationException(\u0026#34;æŠ¥é”™å•¦\u0026#34;); yield return 4; } } è¾“å‡ºï¼š\n1 2 3 4 5 enumerable with exception - OnNext(1) enumerable with exception - OnNext(2) enumerable with exception - OnNext(3) enumerable with exception - OnError: System.ApplicationException: Something Bad Happened Rx è¿˜æä¾›äº†ä¸€ä¸ªæ›´ç®€å•çš„æ–¹æ³•ï¼Œç›´æ¥è®¢é˜…è¿­ä»£ç±»å‹ï¼š\n1 2 IEnumerable\u0026lt;string\u0026gt; names = new[] { \u0026#34;AHpx\u0026#34;, \u0026#34;Yoroion\u0026#34;, \u0026#34;Weeknic\u0026#34;, \u0026#34;GodLeaveMe\u0026#34; }; names.Subscribe(new ConsoleObserver\u0026lt;string\u0026gt;(\u0026#34;subscribe\u0026#34;)); é‚£ä¹ˆå¦‚ä½•åˆå¹¶å¯è§‚å¯Ÿæ•°æ®æµä¸è¿­ä»£ç±»å‹å‘¢ï¼Ÿ\n1 2 3 4 5 6 7 ChatClient client = new ChatClient(); IObservable\u0026lt;string\u0026gt; liveMessages = client.ObserveMessages(\u0026#34;user\u0026#34;,\u0026#34;pass\u0026#34;); IEnumerable\u0026lt;string\u0026gt; loadedMessages = LoadMessagesFromDB(); // å‡è®¾ä»æ•°æ®åº“åŠ è½½æ•°æ® loadedMessages.ToObservable() .Concat(liveMessages) .SubscribeConsole(\u0026#34;merged\u0026#34;); æ³¨æ„çœ‹ï¼Œä»¥ä¸Šä»£ç ä½¿ç”¨äº† Concat åˆå¹¶äº†ä¸¤ä¸ªæµã€‚åœ¨æ‰€æœ‰ Database æ•°æ®ï¼ˆLoaded Messagesï¼‰è¢«åŠ è½½åï¼Œå®æ—¶æ•°æ®ï¼ˆLive Messagesï¼‰æ‰ä¼šè¢«å‘ç»™è§‚å¯Ÿè€…ã€‚\n1 2 3 4 merged - OnNext(loaded1) merged - OnNext(loaded2) merged - OnNext(live message1) merged - OnNext(live message2) ä½ ä¹Ÿå¯ä»¥ç”¨ä»¥ä¸‹å†™æ³•å…äºæ‰‹åŠ¨è½¬æ¢ï¼š\n1 2 3 liveMessages .StartWith(loadedMessages) .SubscribeConsole(\u0026#34;loaded first\u0026#34;); å¯è§‚å¯Ÿæµ â†’ è¿­ä»£ç±»å‹ ä¸ºå•¥è¦æŠŠå¯è§‚å¯Ÿæµè½¬åŒ–æˆè¿­ä»£ç±»å‹å‘¢ï¼Ÿå› ä¸ºæœ‰çš„æ–¹æ³•åªæ¥å—è¿­ä»£ç±»å‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 var observable = Observable.Create\u0026lt;string\u0026gt;(o =\u0026gt; { o.OnNext(\u0026#34;Observable\u0026#34;); o.OnNext(\u0026#34;To\u0026#34;); o.OnNext(\u0026#34;Enumerable\u0026#34;); o.OnCompleted(); // å½“æ‰€æœ‰OnNextä¸­çš„å€¼è¢«æ¶ˆè´¹åï¼Œçº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ return Disposable.Empty; }); var enumerable = observable.ToEnumerable(); // å¯è§‚å¯Ÿæµå®Œæˆæ—¶ï¼Œå¾ªç¯ä¾¿ä¼šç»“æŸ foreach (var item in enumerable) { Console.WriteLine(item); } æŠŠå¯è§‚å¯Ÿæµè½¬æ¢æˆ Listï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 var observable = Observable.Create\u0026lt;string\u0026gt;(o =\u0026gt; { o.OnNext(\u0026#34;Observable\u0026#34;); o.OnNext(\u0026#34;To\u0026#34;); o.OnNext(\u0026#34;List\u0026#34;); o.OnCompleted(); // åªæœ‰å½“Completeä¹‹åï¼ŒListæ‰ä¼šè¢«å‘é€ç»™è§‚å¯Ÿè€… return Disposable.Empty; }); IObservable\u0026lt;IList\u0026lt;string\u0026gt;\u0026gt; listObservable = observable.ToList(); listObservable .Select(lst =\u0026gt; string.Join(\u0026#34;,\u0026#34;, lst)) // ä½¿ç”¨é€—å·åˆ†éš” .SubscribeConsole(\u0026#34;list ready\u0026#34;); è¾“å‡ºï¼š\n1 2 list ready - OnNext(Observable,To,List) list ready - OnCompleted() å¯è§‚å¯Ÿæµ â†’ å­—å…¸ Rx æä¾›äº†å¦‚ä¸‹æ–¹æ³•ï¼š\n1 IObservable\u0026lt;IDictionary\u0026lt;TKey, TSource\u0026gt;\u0026gt; ToDictionary\u0026lt;TSource, TKey\u0026gt;(this IObservable\u0026lt;TSource\u0026gt; source, Func\u0026lt;TSource, TKey\u0026gt; keySelector) ç®€å•ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 IEnumerable\u0026lt;string\u0026gt; cities = new[] { \u0026#34;London\u0026#34;, \u0026#34;Tel-Aviv\u0026#34;, \u0026#34;Tokyo\u0026#34;, \u0026#34;Rome\u0026#34; }; var dictionaryObservable = cities .ToObservable() .ToDictionary(c =\u0026gt; c.Length); dictionaryObservable .Select(d =\u0026gt; string.Join(\u0026#34;,\u0026#34;, d)) .SubscribeConsole(\u0026#34;dictionary\u0026#34;); è¾“å‡ºï¼š\n1 2 dictionary - OnNext([6, London],[8, Tel-Aviv],[5, Tokyo],[4, Rome]) dictionary - OnCompleted() ä½†æ˜¯å½“ä¸¤ä¸ª Key çš„å€¼ç›¸åŒæ—¶ï¼Œå®ƒå°±ä¼šæŠ¥é”™ã€‚\nå¦‚æœä½ éœ€è¦ä¸€ Key å¯¹åº”å¤šå€¼ï¼Œä½ å°±éœ€è¦ Lookup ç±»å‹ï¼š\n1 IObservable\u0026lt;ILookup\u0026lt;TKey, TSource\u0026gt;\u0026gt; ToLookup\u0026lt;TSource, TKey\u0026gt;(this IObservable\u0026lt;TSource\u0026gt; source, Func\u0026lt;TSource, TKey\u0026gt; keySelector) é•¿å¾—å’Œ ToDictionary éå¸¸ç›¸ä¼¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 IEnumerable\u0026lt;string\u0026gt; cities = new[] { \u0026#34;London\u0026#34;, \u0026#34;Tel-Aviv\u0026#34;, \u0026#34;Tokyo\u0026#34;, \u0026#34;Rome\u0026#34;, \u0026#34;Madrid\u0026#34; }; var lookupObservable = cities .ToObservable() .ToLookup(c =\u0026gt; c.Length); lookupObservable .Select(lookup =\u0026gt; { var groups = new StringBuilder(); foreach (var grp in lookup) groups.AppendFormat(\u0026#34;[Key:{0} =\u0026gt; {1}]\u0026#34;,grp.Key,grp.Count()); return groups.ToString(); }) .SubscribeConsole(\u0026#34;lookup\u0026#34;); è¾“å‡ºï¼š\n1 2 lookup - OnNext([Key:6 =\u0026gt; 2][Key:8 =\u0026gt; 1][Key:5 =\u0026gt; 1][Key:4 =\u0026gt; 1]) lookup - OnCompleted() å› ä¸ºä¼¦æ•¦ï¼ˆLondonï¼‰å’Œé©¬å¾·é‡Œï¼ˆMadridï¼‰çš„é•¿åº¦éƒ½æ˜¯ 6ï¼ŒLookup Key 6 å°±æœ‰ä¸¤ä¸ªå€¼ã€‚\nRx åˆ›å»ºå‹æ“ä½œç¬¦ å¯è§‚å¯Ÿå¾ªç¯ ä½¿ç”¨ Observable.Generate æ¥åˆ›å»ºç±»ä¼¼è¿­ä»£çš„æ•°æ®æµï¼š\n1 2 3 4 5 IObservable\u0026lt;TResult\u0026gt; Generate\u0026lt;TState, TResult\u0026gt;( TState initialState, Func\u0026lt;TState, bool\u0026gt; condition, Func\u0026lt;TState, TState\u0026gt; iterate, Func\u0026lt;TState, TResult\u0026gt; resultSelector) ç®€å•ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 IObservable\u0026lt;int\u0026gt; observable = Observable.Generate( 0, //åˆå§‹å€¼ i =\u0026gt; i \u0026lt; 10, //æ¡ä»¶ i =\u0026gt; i + 1, //è¿­ä»£ i =\u0026gt; i*2); //æ•°æ®å¤„ç† observable.SubscribeConsole(); ä½ ä¼šå¾—åˆ°ï¼š0, 2, 4, 6, 8, 10, 12, 14, 16, 18ã€‚\nä½¿ç”¨ Observable.Range ç®€åŒ–ä»¥ä¸Šæ“ä½œï¼š\n1 IObservable\u0026lt;int\u0026gt; Range(int start, int count) é¡¾åæ€ä¹‰ï¼š\n1 2 3 4 IObservable\u0026lt;int\u0026gt; observable = Observable .Range(0, 10) .Select(i =\u0026gt; i*2); è¯»å–æ–‡ä»¶ æˆ‘ä»¬åˆ©ç”¨ Generate æ–¹æ³•æ¥è¯»å–æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 IObservable\u0026lt;string\u0026gt; lines = Observable.Generate( File.OpenText(\u0026#34;TextFile.txt\u0026#34;), //è¿™ä¸ªåœ°æ–¹æœ‰ç‘•ç–µ s =\u0026gt; !s.EndOfStream, //è¿­ä»£åˆ°æ–‡ä»¶æœ«ç«¯ s =\u0026gt; s, //çŠ¶æ€å°±æ˜¯æ–‡ä»¶æµæœ¬èº« s =\u0026gt; s.ReadLine()); lines.SubscribeConsole(\u0026#34;lines\u0026#34;); è¾“å‡ºï¼š\n1 2 3 4 5 lines - OnNext(The 1st line) lines - OnNext(The 2nd line) lines - OnNext(The 3rd line) lines - OnNext(The 4th line) lines - OnCompleted() ä½†æ˜¯æï¼Œæˆ‘ä»¬è‚¯å®šçŸ¥é“ IO æµçš„èµ„æºæ²¡æœ‰åŠæ—¶é‡Šæ”¾ã€‚æ–‡ä»¶è¿˜ä¿æŒåœ¨æ‰“å¼€çš„çŠ¶æ€ã€‚\nåœ¨å¹³æ—¶å†™ C# ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨ using var ... æ¥è‡ªåŠ¨é‡Šæ”¾èµ„æºã€‚\nåœ¨ Rx.NET ä¸­ï¼Œæä¾›äº† Observable.Usingï¼š\n1 2 3 4 5 6 7 8 9 10 11 IObservable\u0026lt;string\u0026gt; lines = Observable.Using( () =\u0026gt; File.OpenText(\u0026#34;TextFile.txt\u0026#34;), stream =\u0026gt; Observable.Generate( stream, //åˆå§‹çŠ¶æ€å°±æ˜¯å®ƒè‡ªå·± s =\u0026gt; !s.EndOfStream, s =\u0026gt; s, s =\u0026gt; s.ReadLine()) ); lines.SubscribeConsole(\u0026#34;lines\u0026#34;); åŸå§‹å¯è§‚å¯Ÿæµ æœ‰äº› Rx åˆ›å»ºå‹æ“ä½œç¬¦æ²¡å•¥ç”¨ï¼Œä½†æ˜¯å¯ä»¥æ‹¿æ¥ç©ç©æˆ–è€…æµ‹è¯•ã€‚\nReturn 1 2 Observable.Return(\u0026#34;Hello World\u0026#34;) .SubscribeConsole(\u0026#34;Return\u0026#34;); è¾“å‡ºï¼š\n1 2 Return - OnNext(Hello World) Return - OnCompleted() Never ä¸€ä¸ªæ°¸ä¸ç»“æŸçš„æ•°æ®æµï¼š\n1 2 Observable.Never\u0026lt;string\u0026gt;() .SubscribeConsole(\u0026#34;Never\u0026#34;); Throw ä¸€ä¸ªè¿è¡Œå³æŠ¥é”™çš„æµï¼š\n1 2 3 Observable.Throw\u0026lt;ApplicationException\u0026gt;( new ApplicationException(\u0026#34;something bad happened\u0026#34;)) .SubscribeConsole(\u0026#34;Throw\u0026#34;); è¾“å‡ºï¼š\n1 2 Throw - OnError: System.ApplicationException: something bad happened Empty 1 2 Observable.Empty\u0026lt;string\u0026gt;() .SubscribeConsole(\u0026#34;Empty\u0026#34;); è¾“å‡ºï¼š\n1 Empty - OnCompleted() ","date":"2022-08-10T00:00:00Z","image":"https://kyocius.github.io/p/rx-magic-3/head_hu60daa3e750dae8efe162b164d024055e_222411_120x120_fill_box_smart1_3.png","permalink":"https://kyocius.github.io/p/rx-magic-3/","title":"Rx.NET å“åº”å¼ç¼–ç¨‹æŒ‡åŒ— 03 - æ·±å…¥æµçš„åˆ›å»º"},{"content":"å‰è¨€ è¿™ä¸€ç« æ˜¯ç‹¬ç«‹äºæ­£å¼ç« èŠ‚çš„ç•ªå¤–ï¼Œè¡¥å……ä¸€ä¸‹ C# å‡½æ•°å¼ç¼–ç¨‹ï¼ˆFunctional Programmingï¼‰ä»¥åŠæµå¼æ¥å£ï¼ˆFluent APIï¼‰çš„çŸ¥è¯†ã€‚\nç­‰ç­‰ï¼Œæˆ‘ä»¬ä¸æ˜¯åœ¨å­¦ Rx.NET å—ï¼Œæ€ä¹ˆåˆè·‘åˆ°å‡½æ•°å¼äº†ï¼Ÿ (ï¼ƒÂ°Ğ”Â°)\nä½  å…ˆ åˆ« æ€¥ï¼ŒäºŒè€…å¹¶ä¸å†²çªã€‚\nRx.NET æä¾›çš„æ–¹æ³•å¤§éƒ¨åˆ†éƒ½æ˜¯å‡½æ•°å¼çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸Šä¸€ç« å­¦åˆ°çš„ FromEventPattern æ–¹æ³•ï¼Œå°±æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼ˆHigh-Order Functionï¼‰ï¼Œå› ä¸ºå®ƒçš„å‚æ•°ä¹Ÿæ˜¯å‡½æ•°ã€‚\næœ‰äº›è€å¤è‘£ Java ç¨‹åºå‘˜è®¤ä¸ºï¼ŒC# å’Œ Java ä¸€æ ·éƒ½æ˜¯çº¯é¢å‘å¯¹è±¡è¯­è¨€ï¼ˆPure OOPï¼‰ï¼Œè¿™æ˜¯å®Œå…¨é”™è¯¯çš„ã€‚ç»è¿‡äºŒåå¹´çš„å‘å±•ï¼ŒC# æ—©å·²è¿›åŒ–æˆä¸€é—¨å¤šèŒƒå¼è¯­è¨€äº†ã€‚\nå‡½æ•°å¼ç¼–ç¨‹ é‚£ä¹ˆå¦‚ä½•ç”¨ C# ç¼–å†™å‡½æ•°å¼ä»£ç å‘¢ï¼Ÿ\nå›é¡¾ä¸€ä¸‹åŸºç¡€çŸ¥è¯†å§ã€‚\nå§”æ‰˜ Delegate ä¸ºäº†ä¼ é€’å‡½æ•°ï¼ŒC# è€æ—©å°±åŠ å…¥äº†å§”æ‰˜ç‰¹æ€§ï¼š\n1 public delegate bool MyDelegateType (string first, string second); åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º MyDelegateType çš„å§”æ‰˜ç±»å‹ã€‚\næˆ‘ä»¬è¿™æ ·ä¸ºå§”æ‰˜èµ‹å€¼ï¼š\n1 2 3 4 MyDelegateType myDel; myDel += \u0026lt;ä¸€äº›å‡½æ•°\u0026gt;; myDel(\u0026#34;first\u0026#34;, \u0026#34;second\u0026#34;); // è¿™æ ·è°ƒç”¨ åŒ¿åæ–¹æ³• Anonymous methods 1 2 3 4 myDel = delegate (string first, string second) { return first.Length == second.Length; } Lambda è¡¨è¾¾å¼ 1 2 3 4 5 // ğŸ‘‡ è¿™å°±æ˜¯ lambda MyDelegateType x = (s1,s2) =\u0026gt; s1 == s2; // ğŸ‘‡ åŒ¿åå‡½æ•° MyDelegateType y = delegate (string s1,string s2) { return s1 == s2; }; Func å’Œ Action è¿™ä¿©éƒ½æ˜¯ .NET é¢„å®šä¹‰å¥½çš„æ ‡å‡†å§”æ‰˜ç±»å‹ã€‚\nä¹Ÿå°±æ˜¯è¯´åˆ«å‚»ä¹ä¹åœ°è‡ªå·±å®šä¹‰å§”æ‰˜ç±»å‹å•¦ï¼Œç”¨å®ƒä¿©å°±å¥½äº†ã€‚\n.NET é¢„å®šä¹‰äº† 17 ç§ Func å’Œ Action å§”æ‰˜ï¼Œå…¨æ”¾åœ¨ System åç§°ç©ºé—´ä¸‹ã€‚\nAction Action ç”¨äºæ— è¿”å›å€¼çš„å‡½æ•°å§”æ‰˜ã€‚\nçœ‹çœ‹å®šä¹‰ï¼š\n1 2 3 4 // ğŸ‘‡ æ— å‚ public delegate void Action(); // ğŸ‘‡ ä¸¤ä¸ªå‚æ•° public delegate void Action\u0026lt;in T1, in T2\u0026gt;(T1 arg1, T2 arg2); ç®€å•ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 public static void ForEach\u0026lt;T\u0026gt;(IEnumerable\u0026lt;T\u0026gt; collection, Action\u0026lt;T\u0026gt; action) { foreach (var item in collection) { action(item); } } // ğŸ‘‡ å®Œæ•´ä½¿ç”¨ ForEach(new[] { \u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34; }, n =\u0026gt; Console.WriteLine(n)); // ğŸ‘‡ çœç•¥å½¢å¼ ForEach(new[] { \u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34; }, Console.WriteLine); Func Func ç”¨äºæœ‰è¿”å›å€¼çš„å‡½æ•°å§”æ‰˜ã€‚\nçœ‹çœ‹å®šä¹‰ï¼š\n1 2 public delegate TResult Func\u0026lt;out TResult\u0026gt;(); public delegate TResult Func\u0026lt;in T1,â€¦,T16, out TResult\u0026gt;(T1 arg,â€¦,T16 arg16); ç®€å•ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 public static void ForEach\u0026lt;T\u0026gt;(IEnumerable\u0026lt;T\u0026gt; collection, Action\u0026lt;T\u0026gt; action, Func\u0026lt;T, bool\u0026gt; predicate) { foreach (var item in collection) { if (predicate(item)) { action(item); } } } æ‡’åŠ è½½ Lazy\u0026lt;T\u0026gt; æˆ‘ä»¬æ¥çœ‹çœ‹ Func ä½œä¸ºå·¥å‚å‡½æ•°çš„ä½œç”¨å§ã€‚\nä½ æœ‰ä¸€ä¸ªå¾ˆè€—æ—¶çš„ç±»ï¼š\n1 2 3 4 class HeavyClass { // åˆå§‹åŒ–éå¸¸è€—æ—¶ } ä½ è¿˜æœ‰ä¸ªç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 class ThinClass { private HeavyClass _heavy; public HeavyClass TheHeavy { get { if (_heavy == null) { _heavy = new HeavyClass(); // å»¶è¿ŸåŠ è½½æ—¶é—´ } return _heavy; } } public void SomeMethod() { var myHeavy = TheHeavy; // çœç•¥åé¢çš„ä½¿ç”¨ } } æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™å°±æ˜¯åœ¨ Java ä¸­å¸¸è§çš„æ„å»ºæ¨¡å¼ã€‚\né‚£å¦‚æœä½ æœ‰ 10 ä¸ªéœ€è¦å»¶è¿ŸåŠ è½½çš„å±æ€§å‘¢ï¼Ÿåƒè¿™æ ·ä¸€ä¸€æ‰‹å†™ get æ–¹æ³•æœªå…ä¹Ÿå¤ªæŠ˜ç£¨äº†ã€‚\nå¤ªç¬¨äº†ï¼Œåœ¨ C# ä¸­æ‰ä¸è¿™ä¹ˆåšï¼\næˆ‘ä»¬æ¥ä½¿ç”¨ System ç©ºé—´ä¸‹çš„æ‡’åŠ è½½ç±» Lazy\u0026lt;T\u0026gt;ï¼š\n1 2 3 4 5 6 7 8 9 10 class ClassWithLazy { Lazy\u0026lt;HeavyClass\u0026gt; _lazyHeavyClass = new Lazy\u0026lt;HeavyClass\u0026gt;(); public void SomeMethod() { var myHeavy = _lazyHeavyClass.Value; //ä½¿ç”¨ myHeavy } } é‚£å¦‚æœ HeavyClass ç±»çš„æ„é€ æ–¹æ³•éœ€è¦å‚æ•°å’‹åŠï¼Ÿ\nä¼ é€’ä¸ª Func ç»™å®ƒï¼š\n1 2 3 4 5 6 Lazy\u0026lt;HeavyClass\u0026gt; _lazyHeavyClass = new Lazy\u0026lt;HeavyClass\u0026gt;(() =\u0026gt; { var heavy = new HeavyClass(...); ... return heavy; }); æµå¼æ¥å£ Fluent API æµå¼æ¥å£ï¼ˆFluent APIï¼‰æ˜¯ä¸€ç§æ–¹æ³•è°ƒç”¨é£æ ¼ï¼š\n1 2 3 4 5 6 7 StringBuilder sbuilder = new StringBuilder(); var result = sbuilder .AppendLine(\u0026#34;Fluent\u0026#34;) .AppendLine(\u0026#34;Interfaces\u0026#34;) .AppendLine(\u0026#34;Are\u0026#34;) .AppendLine(\u0026#34;Awesome\u0026#34;) .ToString(); çœ‹çœ‹ç ´æ™“çš„ ModuleLauncher.Re æ˜¯æ€ä¹ˆå†™çš„å§ï¼šç ´æ™“æ‰“é’±ï¼\n1 2 3 var process = await minecraft.WithAuthentication(\u0026#34;\u0026lt;player\u0026gt;\u0026#34;) .WithJava(@\u0026#34;\u0026lt;java\u0026gt;\u0026#34;) .LaunchAsync(); æ¥ä¸‹æ¥æˆ‘ä»¬åŠ¨æ‰‹å†™ä¸€ä¸ªæµå¼æ¥å£ã€‚\næˆ‘ä»¬å¹³å¸¸ä¸º List æ·»åŠ å…ƒç´ ï¼š\n1 2 3 4 var words = new List\u0026lt;string\u0026gt;(); words.Add(\u0026#34;This\u0026#34;); words.Add(\u0026#34;Feels\u0026#34;); words.Add(\u0026#34;Weird\u0026#34;); ä¸å¤Ÿä¼˜é›…ï¼ç”¨æµå¼æ¥å£å†™ä¸ªæ‰©å±•æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 public static class ListExtensions { public static List\u0026lt;T\u0026gt; AddItem\u0026lt;T\u0026gt;(this List\u0026lt;T\u0026gt; list, T item) { list.Add(item); return list; } } ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æ–¹æ³•é“¾äº†ï¼š\n1 2 3 4 var words = new List\u0026lt;string\u0026gt;(); words.AddItem(\u0026#34;This\u0026#34;) .AddItem(\u0026#34;Feels\u0026#34;) .AddItem(\u0026#34;Weird\u0026#34;); Awesomeï¼ç¬é—´å°±ç®€æ´å¤šäº†ã€‚\n","date":"2022-08-09T00:00:00Z","image":"https://kyocius.github.io/p/rx-magic-ex/head_hu60daa3e750dae8efe162b164d024055e_222411_120x120_fill_box_smart1_3.png","permalink":"https://kyocius.github.io/p/rx-magic-ex/","title":"Rx.NET å“åº”å¼ç¼–ç¨‹æŒ‡åŒ— Ex - å‡½æ•°å¼æ€æƒ³ \u0026 æµå¼æ¥å£"},{"content":"å‰è¨€ åœ¨ä¸Šä¸€ç« é‡Œï¼Œæˆ‘ä»¬å­¦ä¹ äº†å“åº”å¼çš„åŸºæœ¬æ¦‚å¿µã€‚åœ¨è¿™ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªè‚¡ç¥¨ç›‘æ§ç¨‹åºã€‚é¦–å…ˆæˆ‘ä»¬å°†ä½¿ç”¨ä¼ ç»Ÿçš„ .NET äº‹ä»¶ç³»ç»Ÿæ¥å†™ä¸€æ¬¡ï¼Œä¹‹åå†é€šè¿‡ Rx æ¥é‡æ„ã€‚\nä¼ ç»Ÿäº‹ä»¶å†™æ³• å…ˆç¼–å†™ä¸€ä¸ªç±»ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªäº‹ä»¶å±æ€§ï¼š 1 2 3 4 class StockTicker { public event EventHandler\u0026lt;StockTick\u0026gt; StockTick; } ç¼–å†™ä¸€ä¸ªç±»åŒ…å«æˆ‘ä»¬çš„æ•°æ®ï¼š 1 2 3 4 5 class StockTick { public string QuoteSymbol { get; set; } public decimal Price { get; set; } } åˆ›å»ºä¸€ä¸ªç±»æ¥ç›‘å¬å˜åŒ–ï¼Œå¹¶è®¢é˜…äº‹ä»¶ï¼š 1 2 3 4 5 6 7 8 class StockMonitor { public StockMonitor(StockTicker ticker) { ticker.StockTick += OnStockTick; // OnStockTick æ³¨å†Œäº‹ä»¶ } ... } å› ä¸ºæˆ‘ä»¬éœ€è¦æ¯”è¾ƒè‚¡ç¥¨ä»·æ ¼çš„å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å­—å…¸æ¥å­˜å‚¨å…ˆå‰çš„è‚¡ç¥¨æ•°æ®ã€‚ç¼–å†™ä¸€ä¸ªæ–°ç±»ï¼š 1 2 3 4 5 6 7 8 9 10 class StockInfo { public StockInfo(string symbol, decimal price) { Symbol = symbol; PrevPrice = price; } public string Symbol { get; set; } public decimal PrevPrice { get; set; } } ä¹‹åä½ å¯ä»¥åœ¨ StockMonitor ä¸­å£°æ˜ä¸€ä¸ª StockInfo ç±»å‹çš„å±æ€§ã€‚\næ¯å½“è‚¡ç¥¨å˜åŒ–æ—¶ï¼ŒOnStockTick å°±ä¼šè¢«è°ƒç”¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„åº”ç”¨è¿˜è¦å®ç°ä¸€ä¸ªæ–°æ—§æ•°æ®æ¯”è¾ƒçš„åŠŸèƒ½ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ TryGetValue æ–¹æ³•ã€‚å½“æˆ‘ä»¬æƒ³è¦çš„å€¼å­˜åœ¨æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª trueã€‚åœ¨ StockMonitor ä¸­ç¼–å†™ä»¥ä¸‹ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 var _stockInfos = new Dictionary\u0026lt;string, StockInfo\u0026gt;(); void OnStockTick(object sender, StockTick stockTick) { StockInfo stockInfo; var quoteSymbol = stockTick.QuoteSymbol; var stockInfoExists = _stockInfos.TryGetValue(quoteSymbol, out stockInfo); ... } å¦‚æœä¸€ä¸ªè‚¡ç¥¨æ•°æ®å­˜åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¯”è¾ƒå¤§å°äº†ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 const decimal maxChangeRatio = 0.1m; ... var quoteSymbol = stockTick.QuoteSymbol; var stockInfoExists = _stockInfos.TryGetValue(quoteSymbol, out stockInfo); if (stockInfoExists) { var priceDiff = stockTick.Price-stockInfo.PrevPrice; // å˜åŒ–çš„ç™¾åˆ†æ¯” var changeRatio = Math.Abs(priceDiff/stockInfo.PrevPrice); if (changeRatio \u0026gt; maxChangeRatio) { // ç®€å•æ‰“å°ä¸ªä¿¡æ¯ï¼Œç”¨çš„æ˜¯ C# 6.0 ä»¥å‰çš„å†™æ³• Console.WriteLine(\u0026#34;Stock:{0} has changed with {1} ratio, Old Price:{2} New Price:{3}\u0026#34;, quoteSymbol, changeRatio, stockInfo.PrevPrice, stockTick.Price); } //ä¿å­˜è¿™ä¸ªæ–°æ•°æ® _stockInfos[quoteSymbol].PrevPrice = stockTick.Price; } é‚£å¦‚æœæˆ‘ä»¬ä¸æƒ³è¦è®¢é˜…è‚¡ç¥¨æ¶ˆæ¯äº†å’‹åŠï¼Ÿå¹¸è¿çš„æ˜¯ .NET æä¾›äº†æ–¹æ³•æ¥å¹²è¿™ä¸ªæ´»ã€‚åœ¨ StockMonitor é‡Œç¼–å†™ä»¥ä¸‹æ–¹æ³•ï¼š 1 2 3 4 5 public void Dispose() { _ticker.StockTick -= OnStockTick; _stockInfos.Clear(); } å†™ä¸€ç‚¹å‡æ•°æ®ï¼Œæµ‹è¯•ä¸€ä¸‹ç»“æœï¼š 1 2 3 4 5 6 7 8 9 // çç¼–çš„ Symbol: \u0026#34;MSFT\u0026#34; Price: 100 Symbol: \u0026#34;INTC\u0026#34; Price: 150 Symbol: \u0026#34;MSFT\u0026#34; Price: 170 Symbol: \u0026#34;MSFT\u0026#34; Price: 195 // è¿è¡Œç»“æœ Stock:MSFT has changed with 0.7 ratio, Old Price:100 New Price:170 Stock:MSFT has changed with 0.15 ratio, Old Price:170 New Price:195.5 å“‡å“¦ï¼Œæ„Ÿè§‰è¿˜ä¸é”™å˜›ï¼\nä½†æ˜¯è¿™ä¹ˆå†™å°±ä¸€ç‚¹é—®é¢˜æ²¡æœ‰å—ï¼Ÿ\nå¹¶å‘é—®é¢˜ æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œèµ·æ¥æ²¡å•¥é—®é¢˜ï¼Œä½†èƒŒåæœ‰ä¸ªä¸¥é‡æ¼æ´ï¼š\nä¸æ˜¯å¹¶å‘çš„ï¼\nå¦‚æœ StockMonitor è¿è¡ŒæœŸé—´åˆæœ‰æ–°çš„è‚¡ç¥¨å˜åŒ–å’‹åŠï¼Ÿ\nå¾ˆæŠ±æ­‰ï¼Œåªèƒ½ç­‰ç€ç¬¬ä¸€æ¬¡ç¨‹åºç»“æŸã€‚\nçº¿ç¨‹ä¸å®‰å…¨ è™½ç„¶æˆ‘ä»¬çš„ StockInfo å­—å…¸æ”¯æŒå¤šè¯»è€…ï¼ˆMultiple Readersï¼‰åŒæ—¶è¯»å–ï¼Œä½†å½“æˆ‘ä»¬è¯»å–å­—å…¸æ—¶å­—å…¸æ­£åœ¨è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥é”™ã€‚\nè¿™æ˜¯ä½ å¯èƒ½ä¼šè¯´ï¼Œå¯ä»¥æ”¹ç”¨ .NET æä¾›çš„æ— é” ConcurrentDictionary å‘€ï¼è¿™æ ·å°±ä¸æŠ¥é”™äº†ã€‚\nä½†æ˜¯ï¼Œé‚£æˆ‘ä»¬æ¯æ¬¡æ¯”è¾ƒçš„æ–°å€¼åˆæ˜¯è°ï¼Ÿæ˜¯ä¿®æ”¹å‰çš„ï¼Œè¿˜æ˜¯ä¿®æ”¹åçš„ï¼Ÿ\nä½ å¯èƒ½åˆä¼šè¯´ï¼Œå¯ä»¥ä½¿ç”¨çº¿ç¨‹é”ï¼ˆThread Lockï¼‰æ¥é˜»å¡ä¸¤ä¸ªåŒæ—¶å‘ç”Ÿçš„çº¿ç¨‹çš„å…¶ä¸­ä¸€ä¸ªã€‚\nå¯æ˜¯å¦‚æœèµ„æºä¸åŠæ—¶é‡Šæ”¾ï¼Œåˆå¾ˆå®¹æ˜“å¯¼è‡´æ­»é”é—®é¢˜ã€‚\nå“åº”å¼å†™æ³• ä½¿ç”¨ Rx çš„è¯ï¼Œä¼ ç»Ÿäº‹ä»¶å†™æ³•æš´éœ²å‡ºçš„é—®é¢˜å¯ä»¥é€šè¿‡æ›´ç®€å•çš„æ–¹å¼è§£å†³ã€‚\nå®‰è£… Rx.NET ä½ éƒ½çœ‹åˆ°è¿™é‡Œäº†ï¼Œç›¸ä¿¡å’‹å®‰è£…æ ¹æœ¬ä¸ç”¨æˆ‘æ•™ä½ ã€‚\nRx.NET æ”¾åœ¨ System.Reactive åç§°ç©ºé—´ä¸‹ã€‚\näº‹ä»¶è½¬æ¢ Rx.NET æä¾›äº†å¥½ç”¨çš„ FromEventPattern æ–¹æ³•ï¼Œå¸®åŠ©æˆ‘ä»¬å°†äº‹ä»¶è½¬æ¢æˆå¯è§‚å¯Ÿå¯¹è±¡ï¼ˆObservableï¼‰ï¼š\n1 2 3 4 IObservable\u0026lt;EventPattern\u0026lt;StockTick\u0026gt;\u0026gt; ticks = Observable.FromEventPattern\u0026lt;EventHandler\u0026lt;StockTick\u0026gt;, StockTick\u0026gt;( h =\u0026gt; ticker.StockTick += h, h =\u0026gt; ticker.StockTick -= h); è°”è°”ï¼Œçœ‹ä¸æ‡‚æ\u0026hellip;\né‚£æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰å§ï¼š\n1 FromEventPattern\u0026lt;TDelegate,TEventArgs(Action\u0026lt;TDelegate\u0026gt;addHandler, Action\u0026lt;TDelegate\u0026gt; removeHandler) TDelegate æ˜¯åŒ¹é…äº‹ä»¶çš„å§”æ‰˜ â†’ EventHandler\u0026lt;StockTick\u0026gt; TEventArgs å°±æ˜¯ EventArgs â†’ StockTick addHandler å’Œ removeHandler ä¸€èˆ¬å°±ç›´æ¥å†™æˆ Lambda è¡¨è¾¾å¼çš„å½¢å¼ å› ä¸ºæˆ‘ä»¬åªå…³å¿ƒä¼ å…¥çš„ EventArgsï¼Œæ‰€ä»¥ä»£ç å¯ä»¥æ”¹å†™æˆï¼š\n1 2 3 4 var ticks = Observable.FromEventPattern\u0026lt;EventHandler\u0026lt;StockTick\u0026gt;, StockTick\u0026gt;( h =\u0026gt; ticker.StockTick += h, h =\u0026gt; ticker.StockTick -= h) .Select(tickEvent =\u0026gt; tickEvent.EventArgs); æ•°æ®å¤„ç† ç°åœ¨ä½ å·²ç»æœ‰äº†ä¸€ä¸ªå¯è§‚å¯Ÿçš„æ•°æ®æµäº†ï¼Œæˆ‘ä»¬å°†å›´ç»•å®ƒå±•å¼€æŸ¥è¯¢æ“ä½œï¼Œå°±åƒ LINQ ä¸€æ ·ã€‚\nåˆ†ç»„ Group æˆ‘ä»¬è¯•ç€é€šè¿‡ Symbol æ¥ä¸ºæ¯æ”¯è‚¡ç¥¨åˆ†ç»„ï¼š\n1 2 3 4 5 6 // æŸ¥è¯¢è¯­å¥å½¢å¼ from tick in ticks group tick by tick.QuoteSymbol into company // å‡½æ•°å½¢å¼ ticks.GroupBy(tick =\u0026gt; tick.QuoteSymbol); åˆ†æ‰¹ Buffer Buffer ç”¨äºåŒç»„å†…å†åˆ†æ‰¹ï¼ˆBatchï¼‰ã€‚\nåœ¨è¿™é‡Œæ˜¯åŒç»„å†…æ•°æ®ä¸¤ä¸¤å‰åæ¯”è¾ƒï¼š\n1 2 3 4 5 from tick in ticks group tick by tick.QuoteSymbol into company from tickPair in company.Buffer(2, 1) let changeRatio = Math.Abs((tickPair[1].Price - tickPair[0].Price) / tickPair[0].Price) æœ€åå…¨éƒ¨çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 const decimal maxChangeRatio = 0.1 m; var drasticChanges = from tick in ticks group tick by tick.QuoteSymbol into company from tickPair in company.Buffer(2, 1) let changeRatio = Math.Abs((tickPair[1].Price - tickPair[0].Price) / tickPair[0].Price) where changeRatio \u0026gt; maxChangeRatio select new DrasticChange() { Symbol = company.Key, ChangeRatio = changeRatio, OldPrice = tickPair[0].Price, NewPrice = tickPair[1].Price }; æ¶ˆè´¹æ•°æ® 1 2 3 4 5 6 7 8 _subscription = drasticChanges.Subscribe(change =\u0026gt; { Console.WriteLine($\u0026#34;Stock:{change.Symbol} has changed with {change.ChangeRatio} ratio, Old Price: {change.OldPrice} New Price: {change.NewPrice}\u0026#34;); }, ex =\u0026gt; { /* å¤„ç†é”™è¯¯ */}, () =\u0026gt; {/* å“åº”ä»»åŠ¡å®Œæˆ */}); å–æ¶ˆè®¢é˜… 1 2 3 4 public void Dispose() { _subscription.Dispose(); } åŒæ­¥æµ è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨äº‹ä»¶ç³»ç»Ÿçš„é—®é¢˜å—ï¼Ÿ\nå¼‚æ­¥ IO ä¼šå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ã€‚\nå› æ­¤æˆ‘ä»¬è¦å°†æˆ‘ä»¬çš„ ticks å¯è§‚å¯Ÿæ•°æ®æµè½¬æ¢æˆåŒæ­¥çš„ï¼š\n1 2 3 4 5 var ticks = Observable.FromEventPattern\u0026lt;EventHandler\u0026lt;StockTick\u0026gt;, StockTick\u0026gt;( h =\u0026gt; ticker.StockTick += h, h =\u0026gt; ticker.StockTick -= h) .Select(tickEvent =\u0026gt; tickEvent.EventArgs) .Synchronize(); æ€»è§ˆä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 class RxStockMonitor : IDisposable { private IDisposable _subscription; public RxStockMonitor(StockTicker ticker) { const decimal maxChangeRatio = 0.1m; var ticks = Observable.FromEventPattern\u0026lt;EventHandler\u0026lt;StockTick\u0026gt;, StockTick\u0026gt;( h =\u0026gt; ticker.StockTick += h, h =\u0026gt; ticker.StockTick -= h) .Select(tickEvent =\u0026gt; tickEvent.EventArgs) .Synchronize(); var drasticChanges = from tick in ticks group tick by tick.QuoteSymbol into company from tickPair in company.Buffer(2, 1) let changeRatio = Math.Abs((tickPair[1].Price - tickPair[0].Price)/tickPair[0].Price) where changeRatio \u0026gt; maxChangeRatio select new { Symbol = company.Key, ChangeRatio = changeRatio, OldPrice = tickPair[0].Price, NewPrice = tickPair[1].Price }; _subscription = drasticChanges.Subscribe(change =\u0026gt; { WriteLine($\u0026#34;Stock:{change.Symbol} has changed with {change.ChangeRatio} ratio, Old Price: {change.OldPrice} New Price: {change.NewPrice}\u0026#34;); }, ex =\u0026gt; { /* å¤„ç†é”™è¯¯ */}, () =\u0026gt;{/* å“åº”ä»»åŠ¡å®Œæˆ */}); } public void Dispose() { _subscription.Dispose(); } } Rx çš„ä¼˜ç‚¹ æˆ‘ä»¬å·²ç»ç”¨ä¸¤ç§æ–¹å¼ç¼–å†™äº†è¿™ä¸ªè‚¡ç¥¨ç›‘æ§ç¨‹åºï¼Œæ˜¯æ—¶å€™æ¯”è¾ƒä¸¤ç§å†™æ³•äº†ã€‚\nä»£ç æ›´ç´§å‡‘ï¼šæ‰€æœ‰é€»è¾‘é›†ä¸­åœ¨ä¸€èµ·\næ›´å°‘çš„èµ„æºå ç”¨ï¼šRx å‡ ä¹æ²¡æœ‰èµ„æºå¤„ç†çš„å¼€é”€\nå¼ºå¤§çš„æ“ä½œç¬¦ï¼šRx æœ€æ˜æ˜¾çš„ä¼˜åŠ¿\næ›´ç®€å•åœ°åŒæ­¥ï¼šä¸€ä¸ª Synchronize æ–¹æ³•è¶³çŸ£\n","date":"2022-08-08T00:00:00Z","image":"https://kyocius.github.io/p/rx-magic-2/head_hu60daa3e750dae8efe162b164d024055e_222411_120x120_fill_box_smart1_3.png","permalink":"https://kyocius.github.io/p/rx-magic-2/","title":"Rx.NET å“åº”å¼ç¼–ç¨‹æŒ‡åŒ— 02 - åŸºæœ¬ä½¿ç”¨"},{"content":"å‰è¨€ æœ€è¿‘åˆšè¯»äº† Rx.NET in Actionï¼Œå­¦åˆ°çš„æ–°æ¦‚å¿µéå¸¸å¤šï¼Œæ‹…å¿§è‡ªå·±ä¼šæ—¥æ¸é—å¿˜ï¼Œè§‰å¾—æœ‰å¿…è¦å†™ä¸€ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ï¼Œè¯´ä¸å®šä¹Ÿèƒ½å¸®åˆ°ä¸€äº›å¿—åŒé“åˆçš„æœ‹å‹ã€‚\næœ¬ç³»åˆ—å°†ä¼šä½¿ç”¨æˆ‘æ·±çˆ±çš„ C# è¯­è¨€å’Œ Rx.NET æ¡†æ¶æ¥è®²è§£å“åº”å¼ç¼–ç¨‹ï¼ˆReactive Programmingï¼‰çš„é­”æ³• â•°(Â°â–½Â°)â•¯\nèƒŒæ™¯çŸ¥è¯† C# ä¸­çš„å§”æ‰˜ã€æ³›å‹ã€äº‹ä»¶ä»¥åŠ LINQ ç­‰æ¦‚å¿µ Rx = Reactive Extension Rx æ˜¯ç”±å¾®è½¯æ——ä¸‹ä¸€ä¸ªå®éªŒå®¤å‘èµ·çš„ å·¨ç¡¬å¤§æ³•å¥½ å“åº”å¼æ¦‚å¿µ Rx åˆ°åº•æ˜¯å¹²å•¥çš„ï¼Ÿ\né¦–å…ˆæ¥çœ‹çœ‹å¾®è½¯çš„è§£é‡Šï¼šRx = Observables + LINQ + Schedulersã€‚è°”è°”ï¼Œå•¥ç©æ„å„¿ï¼Ÿ\né‚£çœ‹çœ‹å¤§ä½¬æ€ä¹ˆè§£é‡Šçš„å§ï¼šRx = å¤„ç†å¼‚æ­¥æ•°æ®æµã€‚è¿™ä¸ªè§£é‡Šè¿˜è¡Œï¼Œä½†è¿˜æ˜¯ä¸æ˜ç™½ã€‚\nè¿™é‡Œæ˜¯æ›´é€šä¿—çš„è§£é‡Šï¼š\n1 2 3 var a = 1; var b = 2; var c = a + b; // c çš„å€¼æ˜¾ç„¶ä¸º 3 å½“ä½ æ”¹å˜ a æˆ–è€… b å€¼çš„æ—¶å€™ï¼ŒæŒ‰ç…§æˆ‘ä»¬ä»¥å‰çš„æ€ç»´ï¼Œc çš„å€¼å¹¶ä¸ä¼šéšä¹‹å‘ç”Ÿå˜åŒ–ã€‚\nå¦‚æœæˆ‘ä»¬æƒ³è¦ c çš„å€¼éšä¹‹è€Œæ”¹å˜å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œå¿«å¿«ä½¿ç”¨ Rxï¼\nå¯è§‚å¯Ÿå¯¹è±¡ Observable 1 2 3 4 public interface IObservable\u0026lt;T\u0026gt; { IDisposable Subscribe(IObserver\u0026lt;T\u0026gt; observer); } æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³• Subscribeï¼Œè¿”å› IDisposable å¯¹è±¡ï¼ˆä»£è¡¨ç€è®¢é˜…äº‹ä»¶æœ¬èº«ï¼‰ Observable æŒæœ‰ Observer çš„é›†åˆï¼Œåœ¨å€¼æ”¹å˜æ—¶éšæ—¶é€šçŸ¥å®ƒä»¬ IDisposable å¯¹è±¡å¯ä»¥é€šè¿‡ Dispose æ–¹æ³•éšæ—¶å–æ¶ˆè®¢é˜… è§‚å¯Ÿè€… Observer è§‚å¯Ÿè€…çš„æºç å…¶å®ä¹Ÿå¾ˆç®€å•ã€‚\n1 2 3 4 5 6 public interface IObserver\u0026lt;T\u0026gt; { void OnNext(T value); void OnError(Exception error); void OnCompleted(); } OnNext æ–¹æ³•å®šä¹‰å½“è§‚æµ‹çš„å€¼å‡ºç°å˜åŒ–æ—¶ï¼Œè¯¥åšä»€ä¹ˆï¼ˆç±»æ¯”è¿­ä»£ï¼‰ OnError æ–¹æ³•å®šä¹‰å®ƒå‡ºç°é”™è¯¯æ—¶è¯¥åšä»€ä¹ˆ OnCompleted æ–¹æ³•å®šä¹‰å®ƒä»»åŠ¡å®Œæˆæ—¶è¯¥åšä»€ä¹ˆ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå‘ç”Ÿé”™è¯¯æ—¶ï¼Œæ•°æ®æµå°±ä¼šä¸­æ–­ æ“ä½œç¬¦ Operator Rx å¸¦æ¥äº†æµ·é‡çš„æ“ä½œç¬¦ï¼Œå¸®åŠ©æˆ‘ä»¬åˆ†ç±»ã€æŸ¥æ‰¾ã€è½¬æ¢æ•°æ®ã€‚\nRx.NET çš„æ“ä½œç¬¦ä¸å…¶å®ƒè¯­è¨€çš„ Rx ä¸åŒçš„æ˜¯ï¼Œæ“ä½œç¬¦é‡‡ç”¨äº†åŸæ±åŸå‘³çš„ LINQ é£æ ¼ã€‚\nä¸‹é¢æ¥ç‚¹ç®€å•å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 IObservable\u0026lt;string\u0026gt; strings= ... // æ•°æ®æº IDisposable subscription = strings // ä¸€ä¸ª IDisposable ä»£è¡¨äº†è®¢é˜…äº‹ä»¶æœ¬èº« .Where(str =\u0026gt; str.StartsWith(\u0026#34;A\u0026#34;)) .Select(str =\u0026gt; str.ToUpper()) .Subscribe(...); // ä¼ å…¥ Observer æˆ–ç›´æ¥ä¼  OnNext æ–¹æ³• subscription.Dispose(); // ä¸Šé¢è¯´è¿‡äº†ï¼Œå¯ä»¥éšæ—¶å–æ¶ˆè®¢é˜… ä¸Šé¢çš„ä»£ç è¯»èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆæµç•…ï¼Ÿ\nå…¶å®ç¬¬ä¸€è¡Œçœç•¥äº†å¦‚ä½•åˆ›å»ºå¯è§‚å¯Ÿæ•°æ®æºï¼Œä¸“æ³¨äºæ“ä½œç¬¦æœ¬èº«ï¼Œè¦ä¸ç„¶å¤ªåŠé€€äº†ã€‚\nå¦‚ä½•åˆ›å»ºå¯è§‚å¯Ÿçš„æ•°æ®æºå°†åœ¨åé¢çš„ç« èŠ‚è®²è§£ã€‚\nç†è§£äº‹ä»¶å’Œæµ Events \u0026amp; Streams äº‹ä»¶éå¸¸å¥½ç†è§£ï¼Œæ¯”å¦‚æˆ‘ä»¬ç‚¹å‡»ä¸€ä¸ªæŒ‰é’®å°±æ˜¯ä¸€ä¸ªäº‹ä»¶ã€‚\nåœ¨ C# ä¸­ï¼Œäº‹ä»¶ç”±æ•°æ®æºã€ŒEvent Sourceã€å’Œå¤„ç†å™¨ã€ŒEvent Handlerã€ç»„æˆã€‚\nåœ¨ Rx ä¸­ï¼Œã€ŒEvent Sourceã€å¯¹åº”ã€ŒObservableã€è€Œã€ŒEvent Handlerã€å¯¹åº”ã€ŒObserverã€ã€‚\nä¸‡ç‰©çš†æµ A data stream is like a hose: every drop of water is a data packet that needs to go through stations until it reaches the end. Your data also needs to be filtered and transformed until it gets to the real handler that does something useful with it.\nä¸Šé¢è¿™æ®µ Quote æ¥è‡ª Rx.NET in Actionï¼Œå¤§è‡´çš„æ„æ€å°±æ˜¯æ•°æ®å°±åƒæ°´ç®¡å­ä¸€æ ·ï¼Œæˆ‘ä»¬é€šè¿‡æ“ä½œç¬¦è¿‡æ»¤æ°´æµï¼Œæœ€åé€šè¿‡å–·å¤´å°†æ°´æµä¼ æ’­ã€‚\næˆ‘è®¤ä¸ºè¿™æ˜¯å“åº”å¼çš„æ ¸å¿ƒæ¦‚å¿µã€‚åªè¦ä½ æƒ³æŒç»­åœ°ç›‘å¬æŸæ•°æ®çš„å˜åŒ–ï¼Œé‚£ä¹ˆä½¿ç”¨ Rx è®©æ•°æ®å˜æˆå¯è§‚å¯Ÿæµï¼Œç»å¯¹æ˜¯ä¸ªå¥½ä¸»æ„ã€‚\n","date":"2022-08-07T00:00:00Z","image":"https://kyocius.github.io/p/rx-magic-1/head_hu60daa3e750dae8efe162b164d024055e_222411_120x120_fill_box_smart1_3.png","permalink":"https://kyocius.github.io/p/rx-magic-1/","title":"Rx.NET å“åº”å¼ç¼–ç¨‹æŒ‡åŒ— 01 - åŸºç¡€æ¦‚å¿µ"}]